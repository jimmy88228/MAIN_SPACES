<template>
    <div class="bg-page cev-root spin-box flex-column">
        <div class="cev-root bg-shadow padding10 flex-auto tabs-box">
            <div class="tabs">
                <Tabs value="base" type="card">
                    <TabPane label="基础设置" name="base" >
                        <div class="tabs-page">
                            <div class="edit-body cev-max-width">
                                <div class="edit-title">活动信息</div>
                                <EditItem name="活动主图" label="必填">
                                    <div slot="edit">
                                        <UploadImage type="ACTIVITY" single :imgs.sync="actInfo.picture" />
                                    </div>
                                </EditItem>
                                <EditItem name="活动名称" label="必填">
                                    <Input slot="edit" size="large" v-model="actInfo.name" clearable/>
                                </EditItem>
                                <EditItem name="活动时间" label="必填">
                                    <DatePicker slot="edit" :options="options" type="datetimerange" v-model="timeRange" placeholder="选择活动时间" style="width: 200px"></DatePicker>
                                </EditItem>
                                <EditItem name="展示状态" label="必填">
                                    <RadioGroup slot="edit" v-model="actInfo.showType" size="large">
                                        <Radio :label="index" v-for="(item, index) in showStatusList" :key="index">{{ item.label }}</Radio>
                                    </RadioGroup>
                                </EditItem>
                                <EditItem name="关注公众号" label="必填">
                                    <RadioGroup slot="edit" size="large" v-model="actInfo.wxFollowMode">
                                        <Radio :label="index" v-for="(item, index) in followStatusList" :key="index">{{ item.label }}</Radio>
                                    </RadioGroup>
                                </EditItem>
                                <EditItem name="活动规则" label="必填">
                                    <Select slot="edit" style="width:100px;" v-model="actInfo.ruleArticleId">
                                        <Option :value="item.id" v-for="(item, index) in ruleList" :key="index">{{ item.name }}</Option>
                                    </Select>
                                </EditItem>
                                <EditItem name="关联广告位">
                                    <Select slot="edit" style="width:100px;" v-model="actInfo.layoutId">
                                        <Option :value="item.layoutId" v-for="(item, index) in LayoutList" :key="index">{{ item.name }}</Option>
                                    </Select>
                                </EditItem>
                                <div class="edit-title">登记信息</div>
                                <EditItem name="填写项" description="勾选后用户在抽签时需填写该项">
                                    <CheckboxGroup v-model="fillVals" slot="edit">
                                        <Checkbox size="large" v-for="(item, index) in fillInList" :label="index" :key="index">{{ item.questionTitle }}</Checkbox>
                                    </CheckboxGroup>
                                </EditItem>
                                <EditItem name="发售店铺">
                                    <div slot="edit">
                                        <div>
                                            <div class="margin10" v-for="(item, index) in storeList.list" :key="index">
                                                <Input size="large" v-model="storeList.list[index]" clearable/>
                                                <Icon size="20" type="ios-close-circle" class="close-icon" @click="removeSpec(specIndex)" />
                                            </div>
                                        </div>
                                        <Input slot="edit" size="large" v-model="inputStore" clearable/>
                                        <Button class="m-top10" type="default" @click="addStore(inputStore)">添加店铺</Button>
                                    </div>
                                </EditItem>
                                <EditItem name="商品信息" >
                                    <div slot="edit">
                                        <div>
                                            <Button type="default" @click="addSpecType" :disabled="specList.length > specLimit">添加类型</Button>
                                        </div>

                                        <CellGroup>
                                            <div v-for="(specItem, specIndex) in specList" :key="specIndex" class="spec-group">
                                                <Card>
                                                    <div class="spec-area flex- w-s-nowrap" slot="title">
                                                        规格名：<Input placeholder="规格名" style="width:120px;" v-model="specItem.specTitle" />
                                                    </div>
                                                    <div class="w-s-nowrap">规格值：</div>
                                                    <div class="flex- s-val-area">
                                                        <div class="s-val-box flex-">
                                                            <span class="spec-box" v-for="(sValItem, sValIndex) in specItem.valueList" :key="sValIndex">
                                                                <Input placeholder="添加规格" style="width:120px;" v-model="sValItem.specValue" />
                                                                <Icon size="20" type="ios-close-circle" class="close-icon" @click="removeSpec(specIndex, sValIndex)"/>
                                                            </span>
                                                        </div>
                                                        <Button type="default" @click="addSpecVal(specIndex)" class="flex-s0">添加规格值</Button>
                                                    </div>
                                                    <Icon size="20" type="ios-close-circle" class="close-icon" @click="removeSpec(specIndex)" />
                                                </Card>
                                            </div>
                                        </CellGroup>
                                    </div>
                                </EditItem>
                                <EditItem name="规格明细" >
                                    <div slot="edit" class="spec-detail">
                                        <Table ref="table" class="table" :columns="columns" :data="this.productList" border :span-method="handleSpan">
                                            <template slot="prizeAction" slot-scope="p">
                                                <Input placeholder="规格名" style="width:120px;" v-model="p.row.price" />
                                            </template>
                                            <template slot="action" slot-scope="p">
                                                <i-switch v-model="p.row.enable" :true-value="1" :false-value="0">
                                                    <span slot="open">开</span>
                                                    <span slot="close">关</span>
                                                </i-switch>
                                            </template>
                                        </Table>
                                    </div>
                                </EditItem>
                            </div>
                        </div>
                    </TabPane>
                    <TabPane label="编辑模块" name="detail">
                        <div class="tabs-page">
                            <div class="edit-body cev-max-width">
                                <EditItem name="顶部轮播图">
                                    <div slot="edit">
                                        <UploadImage type="ACTIVITY" :single="false" :imgs.sync="actInfo.pictureList" />
                                    </div>
                                </EditItem>
                                <EditItem name="活动详情">
                                    <div slot="edit">
                                        <Editor ref="editor" v-model="actInfo.activityDetail"></Editor>
                                    </div>
                                </EditItem>
                            </div>
                        </div>
                    </TabPane>
                </Tabs>
            </div>
        </div>
        <div class="bg-bottom-toolbar flex-fixed padding10">
            <div class="cev-toolbar end cev-max-width">
                <Button size="large" type="default" @click.native="back">返回</Button>
                <Button size="large" type="primary" @click.native="submit">保存</Button>
            </div>
        </div>
        <Spin v-if="loading" class="spin" size="large" fix></Spin>
    </div>
</template>
<script>
import EditItem from "@/support/components/edit-item";
import { MainApi } from "@/helper/manager/http-manager";
import Editor from "@/components/editor/index";
import StringHelper from "@/helper/utils/string-util";
import MyDate from "@/helper/utils/date-util";
import UploadImage from "@/components/upload-img-group";
import ListPageMixin from "@/helper/mixin/list-page";
import Mixin from "./mixin";

export default {
    name: "ActvityEdit",
    mixins: [ListPageMixin, Mixin],
    data() {
        return {
            isTest: false,
            loading: false,
            data: null,
            oldNowTabs: 0,
            nowTabs: 0,
            options: {
                disabledDate (date) {
                    return false; // date && date.valueOf() < Date.now();
                }
            },
            showStatusList: [
                { id: 0, label: "展示" },
                { id: 1, label: "不展示" },
                { id: 2, label: "测试环境展示" }
            ],
            followStatusList: [
                { id: 2, label: "强制关注" },
                { id: 1, label: "引导关注" },
                { id: 0, label: "关闭" }
            ],
            fillVals: [],
            fillInList: {
                userName: { questionTitle: "姓名" },
                mobilePhone: { questionTitle: "手机" },
                idCard: { questionTitle: "身份证" }
            },
            LayoutList: [],
            ruleList: [],
            inputStore: "",
            storeList: {
                list: []
            },
            actInfo: {
                extraCodeCount: 2,
                shareNeedNums: 1,
                sort: 0,
                ruleArticleId: 0
            },
            productList: [],
            productJson: {},
            temProductList: [],
            specList: [],
            specLimit: 2
        };
    },
    components: { EditItem, Editor, UploadImage },
    mounted() {
        this.initParam();
        this.getLayoutList();
        this.getRuleList();
        this.loadData();
    },
    computed: {
        timeRange: {
            get() {
                return [this.actInfo.startTime, this.actInfo.endTime];
            },
            set(val) {
                this.actInfo.startTime = (val[0] && MyDate.format(val[0])) || "";
                this.actInfo.endTime = (val[1] && MyDate.format(val[1])) || "";
            }
        }
    },
    watch: {
       specList: {
           handler: function(val) {
                if (val.length > 0) {
                    initColumns.call(this, val);
                    getProduct.call(this, val);
                }
           },
           deep: true
       }
    },
    methods: {
        selectTab(index) {
            this.oldNowTabs = this.nowTabs;
            this.nowTabs = index;
        },
        handleSpan ({ row, column, rowIndex, columnIndex }) {
            if (!(columnIndex < this.specList.length)) {
                return [1, 1];
            }
            let lines = this.occupyLine[columnIndex];
            if (rowIndex % lines === 0) {
                return [lines, 1];
            } else {
                return [0, 0];
            }
        },
        initParam() {
            let query = this.$route.query || {};
            this.actId = query.actId || 0;
        },
        check() {
            let actInfo = this.actInfo || {};
            let storeList = this.storeList || {};
            let fillVals = this.fillVals || [];
            let specList = this.specList || [];
            let warn = "";
            if (!StringHelper.trim(actInfo.picture)) {
                warn = "请上传活动主图";
            } else if (!StringHelper.trim(actInfo.name)) {
                warn = "请输入活动名称";
            } else if (!StringHelper.trim(actInfo.startTime) || !StringHelper.trim(actInfo.endTime)) {
                warn = "请选择活动时间";
            } else if (typeof (actInfo.showType) === "undefined") {
                warn = "请设置活动展示状态";
            } else if (typeof (actInfo.wxFollowMode) === "undefined") {
                warn = "请设置是否关注公众号";
            } else if (fillVals.length === 0) {
                warn = "至少选择一个填写项";
            } else if (!storeList.list || storeList.list.length === 0) {
                warn = "至少增加一个店铺";
            } else if (specList.length === 0 || specList[0].valueList.length === 0) {
                warn = "至少增加一个规格";
            } else if (!actInfo.pictureList || actInfo.pictureList.length === 0) {
                warn = "至少增加一个轮播图";
            }
            if (warn) {
                this.$Message.warning(warn);
                return false;
            }
            return true;
        },
        showError(err) {
            this.$Message.error(err);
        },
        getLayoutList() {
            return MainApi.getLayoutList({
                data: {
                    stime: "",
                    etime: "",
                    pageIndex: 1,
                    pageSize: 100,
                    keywords: "",
                    orderBy: ""
                }
            }).then(res => {
                    if (res.code === "1") {
                        this.LayoutList = res.data && res.data.list;
                    } else {
                        return Promise.reject(res.msg);
                    }
                })
                .catch(msg => {});
        },
        getRuleList() {
            this.loading = true;
            return MainApi.postArticleList({
                data: {
                    stime: "",
                    etime: "",
                    pageIndex: 1,
                    pageSize: 100,
                    keywords: "",
                    orderBy: ""
                }
            }).then(res => {
                if (res.code === "1") {
                    this.ruleList = res.data && res.data.list;
                } else {
                    return Promise.reject(res.msg);
                }
            })
            .catch(msg => {
                this.$Message.error(msg || "数据加载失败");
            })
            .finally(() => {
                this.loading = false;
            });
        },
        loadData(actId) {
            actId = parseInt(this.actId) || actId;
            if (!parseInt(actId)) return;
            this.loading = true;
            return MainApi.getDrawActivityDetail({
                data: {
                    activityId: this.actId
                }
            }).then(res => {
                    if (res.code === "1") {
                        let data = res.data || {};
                        let question = data.question;
                        this.storeList = question.store || this.storeList;
                        delete question.store;
                        let fillVals = [];
                        for (let i in question) {
                            fillVals.push(i);
                        }
                        this.fillVals = fillVals;
                        this.specList = data.specList;
                        this.actInfo = data || {};
                        //
                        initColumns.call(this, data.specList);
                        getProduct.call(this, data.specList, data.productList);
                    } else {
                        return Promise.reject(res.msg);
                    }
                })
                .catch(msg => {
                    if (StringHelper.trim(msg)) {
                        this.$Message.error(msg || "数据加载失败");
                    }
                })
                .finally(() => {
                    this.loading = false;
                });
        },
        addStore(inputStore) {
            if (inputStore) {
                let list = this.storeList.list || [];
                let storeStr = list ? "," + list.join(",") + "," : "";
                if (storeStr.indexOf("," + inputStore + ",") !== -1) {
                    this.$Message.warning("已添加了该店铺");
                    return;
                }
                let index = list.length;
                this.$set(this.storeList.list, index, inputStore);
            }
        },
        addSpecType() {
            let specList = this.specList || [];
            if (specList.length > this.specLimit) return;
            specList.push({
                editType: 0,
                specId: 0,
                specTitle: "",
                valueList: []
            });
        },
        addSpecVal(specIndex) {
            let specList = this.specList || [];
            specList[specIndex].valueList.push({
                editType: 0,
                specValue: "",
                specValueId: 0
            });
        },
        removeSpec(specIndex, valIndex) {
            if (typeof (specIndex) !== "undefined" && typeof (valIndex) !== "undefined") {
                this.specList[specIndex].valueList.splice(valIndex, 1);
            } else if (typeof (specIndex) !== "undefined") {
                this.specList.splice(specIndex, 1);
            }
        },
        submit() {
            if (!this.check()) {
                return;
            }
            let reqData = this.actInfo || {};
            let storeList = this.storeList || {};
            let specList = this.specList || [];
            let fillInList = this.fillInList || {};
            let productList = this.productList || [];
            let question = {};
            for (let i = 0; i < this.fillVals.length; i++) {
                let key = this.fillVals[i];
                question[key] = (reqData.question && reqData.question[key]) || fillInList[key];
            }
            question["store"] = storeList;
            reqData["question"] = question;
            reqData["productList"] = productList;
            console.log("actInfo", reqData);
            if (parseInt(this.actId)) {

                updateDrawActivityReq.call(this, reqData);
            } else {
                reqData["specList"] = specList;
               addDrawActvityReq.call(this, reqData);
            }
        },
        back() {
            this.$router.back();
        }
    }
};
//
function getProduct(specList = [], productList) {
    let allL = 0;
    if (productList instanceof Array) {
        this.productJson = getProductBysSpecId(productList);
    }
    loopData.call(this, 0, specList);
    productList = this.temProductList;
    allL = productList.length;
    this.occupyLine = getOccupyLine(specList, allL);
    this.productList = productList;
}
function getProductBysSpecId(productList) {
    let productJson = {};
    for (let i = 0; i < productList.length; i++) {
        let specList = productList[i].specList || [];
        let productId = productList[i].productId || 0;
        let price = productList[i].price || 0;
        let enable = productList[i].enable || 0;
        let key = "";
        for (let j = 0; j < specList.length; j++) {
            key = key ? key + "_" + specList[j].specValueId : specList[j].specValueId;
        }
        productJson[key] = {
            productId,
            price,
            enable
        };
    }
    return productJson;
}

function loopData(specI, specList, addItem = {}) {
    if (specI === 0) { this.temProductList = []; }
    let specTitle = specList[specI].specTitle;
    let valueList = specList[specI].valueList || [];
    let nextValues = (specList[specI + 1] && specList[specI + 1].valueList) || [];
    for (let i = 0; i < valueList.length; i++) {
        let specValue = valueList[i].specValue;
        let specValueId = valueList[i].specValueId;
        let thisAddItem = JSON.parse(JSON.stringify(addItem));
        thisAddItem["specItem" + specI] = specValue;
        if (!thisAddItem.key) {
            thisAddItem.key = [];
        }
        thisAddItem.key.push(specValueId);
        if (!thisAddItem.specList) {
            thisAddItem.specList = [];
        }
        thisAddItem.specList.push({
            specTitle,
            specValue
        });
        if (nextValues && nextValues.length > 0) { // 递归拼装数据
            loopData.call(this, (specI + 1), specList, thisAddItem);
        } else {
            let key = thisAddItem.key.join("_");
            if (this.productJson[key]) {
                this.temProductList.push({
                    ...this.productJson[key],
                    ...thisAddItem
                });
            } else {
                this.temProductList.push({
                    enable: 1,
                    price: "",
                    productId: 0,
                    ...thisAddItem
                });
            }
        }
    }
}
// 动态标题
function initColumns(specList = []) {
    let columns = [];
    let holdColumns = this.columns.splice(-2);
    for (let i = 0; i < specList.length; i++) {
        columns.push({
            title: specList[i].specTitle,
            align: "center",
            key: "specItem" + i
        });
    }
    this.columns = columns.concat(holdColumns);
}
// 获取该列占的行数
function getOccupyLine(specList, allL) {
    let occupyLine = {};
    let line = 1;
    let specL = specList.length;
    for (let i = 0; i < specL; i++) {
        let valueList = specList[i].valueList || [];
        if (i === (specL - 1)) {
            line = allL;
        } else {
            line *= valueList.length;
        }
        occupyLine[i] = (allL / line);
    }
    return occupyLine;
}
function addDrawActvityReq(data) {
    this.loading = true;
    return MainApi.addDrawActivity({
        data: data
    }).then(res => {
            if (res.code === "1") {
                if (res.data) {
                    this.$Message.success("添加成功");
                    this.loadData(res.data);
                }
            } else {
                return Promise.reject(res.msg);
            }
        })
        .catch(msg => {
            if (StringHelper.trim(msg)) {
                this.$Message.error(msg || "数据加载失败");
            }
        })
        .finally(() => {
            this.loading = false;
        });
}
function updateDrawActivityReq(data) {
    if (!parseInt(this.actId)) return;
    this.loading = true;
    return MainApi.updateDrawActivity({
        data: data
    }).then(res => {
            if (res.code === "1") {
                if (res.data) {
                    this.$Message.success("编辑成功");
                    this.loadData(res.data);
                }
            } else {
                return Promise.reject(res.msg);
            }
        })
        .catch(msg => {
            if (StringHelper.trim(msg)) {
                this.$Message.error(msg || "数据加载失败");
            }
        })
        .finally(() => {
            this.loading = false;
        });
}
</script>

<style lang="less" scoped >
    .tabs-box {
        height: 100%;
        display: flex;
        flex-direction: column;
        > * {
            flex: none;
        }
    }
    .tabs {
        flex: 1;
        height: 100%;
        display: flex;
        flex-direction: column;
        .ivu-tabs-content{
            // height:100%;
            .ivu-tabs-tabpane{
                // height:100%;
                .tabs-page{
                    height:calc(100vh - 220px);
                    overflow-y: scroll;
                    overflow-x: hidden;
                    .close-icon{
                        position:absolute;
                        top:0px;
                        right:0px;
                        transform: translate(50%,-50%);
                        opacity: 0;
                        cursor: pointer;
                    }
                    .spec-group{
                        margin:10px 0px;
                        min-width:900px;
                        .ivu-card{
                            border:1px solid #efefef;
                        }
                        .s-val-area{
                            align-items: flex-start;
                            .s-val-box{
                                flex-wrap: wrap;
                                padding:0;
                            }
                        }
                        .spec-box{
                            position:relative;
                            margin-right:20px;
                            margin-bottom:10px;
                        }
                        .spec-box:hover{
                            .close-icon{
                                opacity: 1;
                            }
                        }
                    }
                    .spec-group:hover .ivu-card-body > .close-icon{
                        opacity: 1;
                    }
                    .spec-detail{
                        min-width:900px;
                    }
                }
            }
        }
    }
</style>
