<template>
	<view>
		<scroll-view class="list-scroll-content" :style="{height:boxHeight+'px'}" scroll-y @scrolltolower="waitingSessionList">
			<template v-if="canJoinUser">
				<u-cell-group>
					<u-cell-item 
					v-for="(item, index) in waitingList" :key="index" 
					:arrow="false">
						<view slot="icon" style="position:relative;height:80rpx;">
							<u-avatar :src="item.get_user_info != null ? item.get_user_info.wx_avatar : ''" size="80" mode="square" style="margin-right:20rpx;"
							@click.native.stop="openUserInfo(item)"></u-avatar>
							<u-badge :count="item.get_user_content_count" :absolute="true" style="top:-6rpx;right:0rpx;"></u-badge>
						</view>
						<view slot="title" class="title-box">
							{{item.session_from}}
							{{item.get_user_info != null ? item.get_user_info.wx_nick_name : ''}}
						</view>
						<view slot="label" class="clamp label-box">{{item.get_user_content_once.content_search}}</view>
						<view slot="right-icon" class="right-box">
							<u-button type="primary" size="mini" :loading="item.loading" @click.stop="userJoinSession(index, item.id)">接入</u-button>
							<view style="line-height: 1.5;">{{item.get_user_content_once.created_at_format}}</view>
						</view>
					</u-cell-item>
				</u-cell-group>
				
				<!-- 空白页 -->
				<u-empty v-if="waitingList.length === 0" 
				text="暂无客户" 
				mode="data" 
				:style="{height: boxHeight +'px'}"></u-empty>
			</template>
			<template v-else>
				<!-- 无权接入 -->
				<u-empty
				text="无权主动接入客户" 
				mode="permission" 
				:style="{height: boxHeight +'px'}"></u-empty>
			</template>
			
		</scroll-view>
	</view>
</template>

<script>
import {mapState, mapMutations} from 'vuex';

/**
 * 待接入 - 客户列表
 */	
export default {
	name: "csWaitingList",
	components: {
	},
	props:{
		boxHeight:{
			type:Number,
			default: 800,
		},
	},
	data() {
		return {
			// 等待接入的列表
			waitingList: [],
			waitingTotal: 0,
			waitingPageSize: 20,
			waitingCurrPage: 1,
			
			// admin info
			info:{},
			
			canJoinUser: true,
		}
	},
	mounted(){

	},
	watch:{
		'info'( to ){
			if( to.worker != null && to.worker.get_group !=null && to.worker.get_group.can_join ==0 ){
				this.canJoinUser = false;
			}
			else{
				this.canJoinUser = true;
			}
		}
	},
	methods: {
		...mapMutations(['setKefuCount', 'setWaitingunReadCount']),
		// 父组件触发初始化
		initData( info ){
			this.info = info;
			
			this.waitingSessionList();
		},
		// 获取等待加入的会话列表
		waitingSessionList( currPage = 0 ){
			this.waitingCurrPage = currPage > 0 ? currPage : this.waitingCurrPage;
		
			this.$u.post( this.$api.csSessionList, {
				worker_id: this.info.worker.id,
				status: 0, // 0 等待接入
				pageSize: this.waitingPageSize,
				page: this.waitingCurrPage,
			})
			.then( (response) => {
				var res = response.data;
				if( res.code ){
					this.waitingList = res.data.items;
					this.waitingTotal = res.data.total;
					
					if( this.waitingTotal > 0 ){
						this.setKefuCount( 1 );
					}
					
					// 更新等待总数
					this.setWaitingunReadCount( this.waitingList.length );
				}
			});
		},
		// 把用户接入到“接收”会话
		userJoinSession( index, sessionId ){
			if(this.info.worker.status > 0 ){
				this.waitingList[ index ].loading = true;
				this.$u.post( this.$api.csJoinSession, {
					from_worker_id: 0,
					to_worker_id: this.info.worker.id,
					session_id: sessionId,
				})
				.then( (response) => {
					this.waitingList[ index ].loading = false;
					var res = response.data;
					if( res.code ){
						
						// 把未读红点设为 0
						this.waitingList[ index ].get_user_content_count = 0;
						
						// 直接把接入的用户作为选中的session
						var sessInfo = this.waitingList[ index ];
						sessInfo['worker_id'] = this.info.worker.id;
						this.$emit('join-success', { sess:sessInfo });

						// 从等待列表 移除这个用户
						this.$delete(this.waitingList, index);
						this.waitingTotal --;
					}
					else{
						this.$u.toast(res.message);
					}
				});
			}
			else{
				this.$u.toast('当前客服处于离线状态，不能接入用户');
			}
		},
		// 查看用户信息
		openUserInfo( item ){
			this.$emit('on-view-user', {sessInfo: item});
		}
	},
}
</script>
	
<style lang="scss">
.list-scroll-content {
	height: 100%;
}

.uni-swiper-item {
	height: auto;
}

.label-box{
	font-size: $font-sm;
	color:#bbb;
	line-height:1;
	margin-top:4rpx;
	max-width: 480rpx;
}
.title-box{
	line-height: 1;
}
.right-box{
	font-size: $font-sm;
	color:#bbb;
	text-align: center;
}
</style>