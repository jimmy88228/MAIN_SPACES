<template>
	<view>
		<u-popup v-model="showPopup" mode="bottom" closeable>
			<view style="border-bottom: 2rpx solid #ddd;padding:20rpx 10rpx;">全部客服人员</view>
			<view class="u-tabs-box" style="padding:10rpx;background-color: #fff;">
				<u-search placeholder="输入 用户名 搜索" v-model="keyword" 
				@clear="loadData"
				@search="search" 
				@custom="search"></u-search>
			</view>
			
			<scroll-view class="list-scroll-content" :style="{height:scrollHeight+'px'}" scroll-y @scrolltolower="loadData">
				<u-cell-group>
					<u-cell-item
					v-for="(item, index) in workerList" :key="index" 
					:arrow="false"
					@click="openSession(item)">
						<view slot="icon" style="margin-right:20rpx;">
							<u-avatar :src="item.avatar_format" size="80" mode="square"></u-avatar>
						</view>
						<view slot="title">
							<view>昵称：{{item.nick_name}} <u-tag :text="item.group_name" size="mini" style="margin-left:10rpx;"></u-tag></view>
							<view>
								<text>用户名：{{item.get_admin_info.name}}</text>
							</view>
						</view>
						<view slot="right-icon">
							<template v-if="item._disabled">
								<u-tag text="不能转接" type="error" size="mini"></u-tag>
							</template>
							<template v-else>
								<u-button type="success" size="mini" @click.stop="transferSession(item.id)">转接</u-button>
							</template>
						</view>
					</u-cell-item>
				</u-cell-group>
				
				<!-- 空白页 -->
				<u-empty v-if="workerList.length === 0" 
				text="暂无客服人员" 
				mode="data" 
				:style="{height: scrollHeight +'px'}"></u-empty>
				
			</scroll-view>
		</u-popup>
	</view>
</template>

<script>
/**
 * 客服转接 - 客户列表
 */	
export default {
	name: "csTransferSession",
	components: {
	},
	data() {
		return {
			showPopup: false,
			
			scrollHeight: 500,
			
			// 会话详情
			sessInfoId: 0,
			
			// admin info
			info:{},
			
			workerList: [],
			workerTotal: 0,
			workerPageSize: 20,
			workerCurrPage: 1,
			
			// 搜索关键词
			keyword:'',
		}
	},
	mounted(){
		this.init();
	},
	methods: {
		init(){
			// 计算屏幕高度
			var system = uni.getSystemInfoSync();
			this.scrollHeight = system.windowHeight - 80;
		},
		// 提供给父组件使用
		openPopup( info, sessInfoId ){
			this.showPopup = true;
			this.sessInfoId = sessInfoId;
			this.info = info;
			
			// 加载在线客服列表
			this.loadData();
		},
		// 加载在线客服列表
		loadData(){
			this.$util.showLoading( this );
			this.$u.post( this.$api.csWorkerList, {
				exclude_oneself: 1,
				pageSize: this.workerPageSize,
				page: this.workerCurrPage,
			})
			.then( (response) => {
				this.$util.hideLoading();
				var res = response.data;
				if( res.code ){
					this.workerList = res.data.items;
				}
			});
		},
		search(){
			this.$util.showLoading( this );
			this.$u.post( this.$api.csWorkerList, {
				exclude_oneself: 1,
				searchq: this.keyword,
				searchqType: 'userName',
				pageSize: this.workerPageSize,
				page: this.workerCurrPage,
			})
			.then( (response) => {
				this.$util.hideLoading();
				var res = response.data;
				if( res.code ){
					this.workerList = res.data.items;
				}
			});
		},
		// 转接动作
		transferSession( toWorkerId ){
			this.$util.showLoading( this );
			// 发送转接请求
			this.$u.post( this.$api.csSessionTransfer, {
				session_id: this.sessInfoId,
				from_worker_id: this.info.worker.id,
				to_worker_id: toWorkerId,
			})
			.then( (response) => {
				this.$util.hideLoading();
				var res = response.data;
				if( res.code ){
					this.$u.toast( res.message );
					// 通知父组件
					this.$emit('on-success', {});
					this.showPopup = false;
				}
			});
		}
	},
}
</script>

<style lang="scss">	
.list-scroll-content {
	height: 100%;
}
</style>