<template>
	<view>
		<scroll-view class="list-scroll-content" :style="{height:boxHeight+'px'}" scroll-y @scrolltolower="joinedSessionList">
			<u-cell-group>
				<u-cell-item
				v-for="(item, index) in myList" :key="index" 
				:arrow="false">
					<view slot="icon" style="position:relative;height:80rpx;">
						<u-avatar :src="item.get_user_info != null ? item.get_user_info.wx_avatar : ''" size="80" mode="square" style="margin-right:20rpx;" 
						@click.native.stop="openUserInfo(item)"></u-avatar>
						<u-badge :count="item.get_user_content_count" :absolute="true" style="top:-6rpx;right:0rpx;"></u-badge>
					</view>
					<view slot="title" class="title-box">
						{{item.session_from}}
						{{item.get_user_info != null ? item.get_user_info.wx_nick_name : ''}}
					</view>
					<view slot="label" class="clamp label-box">
						{{item.get_user_content_once != null ? item.get_user_content_once.content_search : ''}}
						{{item.get_session_join_log != null 
						&& item.get_session_join_log.get_from_worker_info != null
						&& typeof(item.get_session_join_log.get_from_worker_info) != 'undefined' ? 
						'来源：'+item.get_session_join_log.get_from_worker_info.nick_name : ''}}
					</view>
					<view slot="right-icon" class="right-box">
						<view>
							<u-button type="success" size="mini" @click.stop="openSession(item)">进入会话</u-button>
						</view>
						<view>{{item.get_user_content_once != null ? item.get_user_content_once.created_at_format : ''}}</view>
					</view>
				</u-cell-item>
			</u-cell-group>
			
			<!-- 空白页 -->
			<u-empty v-if="myList.length === 0" 
			text="暂无客户" 
			mode="data" 
			:style="{height: boxHeight +'px'}"></u-empty>
			
		</scroll-view>
	</view>
</template>

<script>
import {mapState, mapMutations} from 'vuex';

/**
 * 接待中 - 客户列表
 */	
export default {
	name: "csJoinedList",
	components: {
	},
	props:{
		boxHeight:{
			type:Number,
			default: 800,
		},
	},
	data() {
		return {
			// 已经接入的列表
			myList:[],
			myTotal: 0,
			myPageSize: 20,
			myCurrPage: 1,
			
			// admin info
			info:{},
			
			// 未处理的用户总数
			unReadUserCount: 0,
		}
	},
	mounted(){

	},
	methods: {
		...mapMutations(['setSelectedCsSession', 'setJoinedunReadCount']),
		// 父组件触发初始化
		initData( info ){
			this.info = info;
			
			this.joinedSessionList();
		},
		// 加载接入中的用户列表
		joinedSessionList( currPage = 0 ){
			this.myCurrPage = currPage > 0 ? currPage : this.myCurrPage;
		
			this.$u.post( this.$api.csSessionList, {
				worker_id: this.info.worker.id,
				status: 1, // 1 已接入
				pageSize: this.myPageSize,
				page: this.myCurrPage,
			})
			.then( (response) => {
				var rs = response.data;
				if( rs.code ){
					this.myList = rs.data.items;
					this.myTotal = rs.data.total;
					this.unReadUserCount = rs.data.unReadUserCount;
					
					// 更新接入总数
					this.setJoinedunReadCount( this.unReadUserCount );
				}
				else{
					this.$u.toast( rs.message );
				}
			});
		},
		// 打开会话
		openSession( item ){
			// 把内容参数传递到对话框组件
			this.setSelectedCsSession(item);

			uni.navigateTo({
				url:'/pages/app/customer-service-worker/cs-session?sess_id='+ item.id ,
			});
		},
		// 查看用户信息
		openUserInfo( item ){
			this.$emit('on-view-user', {sessInfo: item});
		}
	}
}
</script>
	
<style lang="scss">
.list-scroll-content {
	height: 100%;
}

.uni-swiper-item {
	height: auto;
}

.label-box{
	font-size: $font-sm;
	color:#bbb;
	line-height:1;
	margin-top:4rpx;
	max-width: 480rpx;
}
.title-box{
	line-height: 1;
}
.right-box{
	font-size: $font-sm;
	color:#bbb;
	text-align: center;
}
</style>