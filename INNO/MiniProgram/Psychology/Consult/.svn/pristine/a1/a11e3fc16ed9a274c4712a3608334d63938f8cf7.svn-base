<template>
  <view :class="!isEmpty ? 'bg_f7' : 'bg_fff'">
    <view class="tutor-page">
      <page-nav>
        <template slot="title"> 选择心理导师 </template>
      </page-nav>
      <view v-if="!isEmpty">
        <view v-for="(pageItem, pageIndex) in tutorList" :key="pageIndex">
          <view class="tutor-item" v-for="(item, index) in pageItem" :key="index" @click="consult"
            :data-consultant-id="item.consultantId">
            <view class="flex-b-c">
              <view class="flex flex-c-c">
                <image class="avatar m-r-25" :src="item.profilePicture" />
                <view>
                  <view class="font-28 bold m-b-10">{{ item.name }}</view>
                  <view class="C_7f font-20">{{
                  item.qualification
                }}</view>
                </view>
              </view>
              <view class="consult">咨询</view>
            </view>
            <view class="flex f-wrap good-at">
              <view class="good-at-item" v-for="(goodAtITem, goodAtIndex) in item.fields" :key="goodAtIndex">
                {{ goodAtITem }}
              </view>
            </view>
          </view>
        </view>
      </view>
      <view class="absolute empty" v-else>
        <image :src="emptyIcon" class="empty-icon" mode="scaleToFill" />
        <view class="C_B2 font-32">暂无可以咨询的导师哦~</view>
      </view>
    </view>
  </view>
</template>

<script>
  import UniApi from "@/common/support/tools/uni-api-promise";
  const app = getApp();
  const pageOption = Page.BasePage({
    data() {
      return {
        isEmpty: false,
        pageIndex: 0,
        pageSize: app.Conf.PAGE_SIZE,
        hasMore: true,
        emptyIcon: require("@/static/list-empty.png"),
        tutorList: [],
      };
    },
    onReady() {
      this.init();
    },
    methods: {
      init() {
        this.tutorList = [];
        this.pageIndex = 0;
        this.hasMore = true;
        this.isEmpty = false;
        this.loadData();
      },
      loadData() {
        let pageIndex = this.pageIndex ? this.pageIndex + 1 : 1;
        return this.$Http(this.$Apis.selectConsultantByPage, {
            data: {
              pageIndex,
              pageSize: this.pageSize,
            },
          })
          .then((res) => {
            if (res.code == 1) {
              let data = res.data || {};
              this.pageIndex = pageIndex;
              let currPage = pageIndex - 1 ? pageIndex - 1 : 0;
              this.tutorList[currPage] = data.list || [];
              this.hasMore = this.pageIndex * this.pageSize < data.totalCount;
              this.setEmpty(this.tutorList);
              UniApi.stopPullDownRefresh();
            }
            return res;
          })
          .catch(() => {
            this.setEmpty(this.tutorList);
          });
      },
      jump({
        currentTarget
      }) {
        this.jumpAction(dataset.url);
      },
      setEmpty(data) {
        if (data instanceof Array) {
          if (data.length == 0 || !data[0] || (data[0] && data[0].length == 0)) {
            this.isEmpty = true;
          } else {
            this.isEmpty = false;
          }
        } else {
          this.isEmpty = false;
        }
      },

      consult({
        currentTarget
      }) {
        let dataset = currentTarget.dataset || {};
        this.jumpAction(
          `/pages/psychology/resume/resume?consultantId=${dataset.consultantId}`
        );
      },
    },
    onReachBottom() {
      console.log("到达底部");
      if (this.hasMore) {
        this.loadData();
      }
    },
    onUnload() {},
    onShow() {},
  });
  export default pageOption;
</script>

<style lang="scss" scoped>
  .tutor-page {
    padding: 18rpx 21rpx 64rpx 21rpx;
    min-height: 100vh;
    box-sizing: border-box;
    width: 100%;

    .tutor-item {
      border-radius: 17rpx;
      background: #ffffff;
      margin-top: 20rpx;

      &>view:first-child {
        padding: 44rpx 32rpx 44rpx 24rpx;
        border-bottom: 2rpx solid #EFEFEF;
      }

      .avatar {
        flex-shrink: 0;
        width: 120rpx;
        height: 120rpx;
        border-radius: 50%;
        background-color: #efefef;
      }

      .good-at {
        padding: 0rpx 24rpx 23rpx 24rpx;

        .good-at-item {
          margin: 18rpx 8rpx 0rpx 8rpx;
          padding: 5rpx 12rpx;
          background: rgba($color: #d0fcff, $alpha: 0.2);
          border-radius: 33rpx;
          color: #229FE7;
          margin-right: 8rpx;
          font-size: 18rpx;
          border: 2rpx solid rgba($color: #07C5EF, $alpha: 0.2);
        }
      }


      .consult {
        padding: 11rpx 24rpx;
        background: #f2fbff;
        border-radius: 10rpx;
        font-size: 26rpx;
        color: #008acb;
        font-weight: bold;
        flex-shrink: 0;
      }
    }
  }

  // 暂无数据
  .empty {
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;

    .empty-icon {
      width: 254rpx;
      height: 254rpx;
      margin-bottom: 47rpx;
      margin: 0 auto;
    }
  }
</style>