<style lang="scss">
page{
	background-color: $page-color-base;
}

@font-face {font-family:"HMfont-home";src:url('data:application/x-font-woff2;charset=utf-8;base64,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') format('woff2');}
.icon {
	font-family:"HMfont-home" !important;
	font-size:56upx;
	font-style:normal;
	color: #333;
	&.biaoqing:before {
	  content: "\e797";
	}
	&.jianpan:before {
	  content: "\e7b2";
	}
	&.yuyin:before {
	  content: "\e805";
	}
	&.tupian:before {
	  content: "\e639";
	}
	&.chehui:before {
	  content: "\e904";
	}
	&.luyin:before {
	  content: "\e905";
	}
	&.luyin2:before {
	  content: "\e677";
	}
	&.other-voice:before {
	  content: "\e667";
	}
	&.my-voice:before {
	  content: "\e906";
	}
	&.hongbao:before {
	  content: "\e626";
	}
	&.tupian2:before {
	  content: "\e674";
	}
	&.paizhao:before {
	  content: "\e63e";
	}
	&.add:before {
	  content: "\e655";
	}
	&.close:before {
	  content: "\e607";
	}
	&.to:before {
	  content: "\e675";
	}
}
.hidden{
	display: none !important;
}
.popup-layer{
	transition: all .15s linear;
	width: 100%;
	height: 42vw;
	background-color: #f3f3f3;
	border-top: solid 1upx #ddd;
	position: fixed;
	z-index: 20;
	top: 100%;
	
	&.showLayer{
		transform: translate3d(0,-42vw,0);
	}
	.emoji-swiper{
		padding: 0 2%;
		background-color: #ffff;
		
		swiper-item{
			display: flex;
			align-content: flex-start;
			flex-wrap: wrap;
			view{
				width: 12vw;
				height: 12vw;
				display: flex;
				justify-content: center;
				align-items: center;
				image{
					width: 8.4vw;
					height: 8.4vw;
				}
			}
		}
	}
	.more-layer{
		width: 100%;
		height: 42vw;
		padding: 20upx 2%;
		
		.list{
			width: 100%;
			display: flex;
			flex-wrap: wrap;
			.box{
				width: 18vw;
				height: 18vw;
				border-radius: 20upx;
				background-color: #fff;
				display: flex;
				justify-content: center;
				align-items: center;
				margin: 0 3vw 2vw 3vw;
				.icon{
					font-size: 70upx;
				}
			}
		}
	}
}

.input-box{
	width: 100%;
	min-height: 100upx;
	padding: 0 1%;
	background-color: #f2f2f2;
	display: flex;
	position: fixed;
	z-index: 20;
	bottom:0;
	transition: all .15s linear;
	
	&.showLayer{
		transform: translate3d(0,-42vw,0);
	}
	.more{
		flex-shrink: 0;
		width: 90upx;
		height: 100upx;
		display: flex;
		justify-content: center;
		align-items: center;
	}
	
	.send{
		margin-left: 20upx;
		flex-shrink: 0;
		width: 100upx;
		height: 100upx;
		display: flex;
		align-items: center;
		.btn{
			width: 90upx;
			height: 56upx;
			display: flex;
			justify-content: center;
			align-items: center;
			background:$uni-color-success;
			color: #fff;
			border-radius: 6upx;
			font-size: 24upx;
		}
	}
	.textbox{
		width: 100%;
		min-height: 70upx;
		margin-top: 15upx;
		.text-mode{
			width: 100%;
			min-height: 70upx;
			display: flex;
			background-color: #fff;
			border-radius: 40upx;
			.box{
				width: 100%;
				padding-left: 30upx;
				min-height: 70upx;
				display: flex;
				align-items: center;
				textarea{
					width: 100%;
				}
			}
			.em{
				flex-shrink: 0;
				width: 80upx;
				padding-left: 10upx;
				height: 70upx;
				display: flex;
				justify-content: center;
				align-items: center;
			}
		}
	}
}

.content{
	width: 100%;
	
	.msg-list{
		width: 100%;
		position: absolute;
		top: 0;
		bottom: 100upx;
		
		.loading{
			//loading动画
			display: flex;
			justify-content: center;
			@keyframes stretchdelay {
				0%, 40%, 100% {
					transform: scaleY(0.6);
				}
				20% {
					transform: scaleY(1.0);
				}
			}
			.spinner {
				margin: 20upx 0;
				width: 60upx;
				height: 100upx;
				display: flex;
				align-items: center;
				justify-content: space-between;
				view {
					background-color: #f06c7a;
					height: 50upx;
					width: 6upx;
					border-radius: 6upx;
					animation: stretchdelay 1.2s infinite ease-in-out;
				}
				.rect2 {
				  animation-delay: -1.1s;
				}
				.rect3 {
				  animation-delay: -1.0s;
				}
				.rect4 {
				  animation-delay: -0.9s;
				}
				.rect5 {
				  animation-delay: -0.8s;
				}
			}
		}

		.row{
			padding: 20upx;
			&:first-child{
				margin-top: 20upx;
			}
			
			.system{
				display: flex;
				justify-content: center;
				view{
					padding: 0 30upx;
					height: 50upx;
					display: flex;
					justify-content: center;
					align-items: center;
					background-color: #c9c9c9;
					color: #fff;
					font-size: 24upx;
					border-radius: 40upx;
				}
			}

			.my .left,.other .right{
				width: 100%;
				display: flex;

				.bubble{
					max-width: 70%;
					min-height: 50upx;
					border-radius: 10upx;
					padding: 12upx 20upx;
					align-items: center;
					font-size: 32upx;
					word-break: break-word;
					
					&.img{
						background-color: transparent;
						padding:0;
						overflow: hidden;
						image{
							max-width: 280rpx;
							max-height: 280rpx;
						}
					}
					
					&.card{
						.title{
							font-size: $font-base;
							max-width: 300rpx;
							line-height: 2;
						}
						.img{
							background: center center no-repeat;
							background-size: 100% auto;
							margin:0 auto;
							width: 280rpx;
							height: 280rpx;
							border-radius:10rpx;
						}
						.tips{
							text-align: center;
							font-size: $font-sm;
						}
					}
				}
			}
			.my .right,.other .left{
				flex-shrink: 0;
				width: 80upx;
				height: 80upx;
				image{
					width: 80upx;
					height: 80upx;
					border-radius: 10upx;
				}
			}
			.my{
				width: 100%;
				display: flex;
				justify-content: flex-end;
				.left{
					min-height: 80upx;
					align-items: center;
					justify-content: flex-end;

					.bubble{
						background-color:#9eea6a;
						position: relative;
						.arrow-out{
							width: 0;
							height: 0;
							border-width: 16rpx;
							border-style: solid;
							border-color: transparent transparent transparent #9eea6a;
							position: absolute;
							top: 18rpx;
							right: -28rpx;
						}
					}
				}
				.right{
					margin-left: 15upx;
					background-color: #ddd;
				}
			}
			.other{
				width: 100%;
				display: flex;
				.left{
					margin-right: 15upx;
				}
				.right{
					flex-wrap: wrap;
					.username{
						width: 100%;
						height: 45upx;
						font-size: 24upx;
						color: #999;
						display: flex;
						.name{
							margin-right: 20upx;
						}
					}
					.bubble{
						background-color: #fff;
						color: #333;
						position: relative;
						.arrow-out{
							width: 0;
							height: 0;
							border-width: 16rpx;
							border-style: solid;
							border-color: transparent #fff transparent transparent;
							position: absolute;
							top: 20rpx;
							left: -28rpx;
						}
					}
				}
			}
		}
	}
}
</style>

<template>
	<view class="container">
		<global-com></global-com>
		
		<view class="content" @touchstart="hideDrawer">
			<scroll-view class="msg-list" scroll-y="true" 
			upper-threshold="50"
			:scroll-with-animation="scrollAnimation" 
			:scroll-top="scrollTop" 
			:scroll-into-view="scrollToView" 
			@scrolltoupper="loadHistory">
			
				<!-- 加载历史数据waitingUI -->
				<view v-show="isHistoryLoading" class="loading">
					<view class="spinner">
						<view class="rect1"></view>
						<view class="rect2"></view>
						<view class="rect3"></view>
						<view class="rect4"></view>
						<view class="rect5"></view>
					</view>
				</view>
				
				<view class="row" v-for="(row,index) in msgList" :key="index" :id="'msg'+row.msg.id">
					
					<!-- 系统消息 -->
					<block v-if="row.type=='system'" >
						<view class="system">
							<!-- 文字消息 -->
							<view v-if="row.msg.type=='text'" class="text">
								{{row.msg.content.text}}
							</view>
						</view>
					</block>
					
					<!-- 用户消息 -->
					<block v-if="row.type=='user'">
						
						<!-- 自己发出的消息 -->
						<view class="my" v-if="row.msg.userinfo.id==myuid">
							<!-- 左-消息 -->
							<view class="left">

								<!-- 文字消息 -->
								<view v-if="row.msg.type=='text'" class="bubble">
									<span class="arrow-out"></span>
									<rich-text :nodes="row.msg.content.text"></rich-text>
								</view>
								<!-- 图片消息 -->
								<view v-if="row.msg.type=='image'" class="bubble img" @click="showPic(row.msg)">
									<span class="arrow-out"></span>
									<image :src="row.msg.content.url" style="width:140px;height:140px;"></image>
								</view>
							</view>
							<!-- 右-头像 -->
							<view class="right">
								<image :src="row.msg.userinfo.face"></image>
							</view>
						</view>
						
						<!-- 别人发出的消息 -->
						<view class="other" v-if="row.msg.userinfo.id != myuid">
							<!-- 左-头像 -->
							<view class="left">
								<image :src="row.msg.userinfo.face"></image>
							</view>
							<!-- 右-用户名称-时间-消息 -->
							<view class="right">
								
								<!-- 文字消息 -->
								<view v-if="row.msg.type=='text'" class="bubble">
									<text class="arrow-out"></text>
									<rich-text :nodes="row.msg.content.text"></rich-text>
									
									<!--a 标签的内容-->
									<view v-if="row.msg.tags != null" 
									v-for="(titem, tindex) in row.msg.tags" :key="tindex" 
									style="color:#2d8cf0;margin-top:30rpx;"
									@click="aTagClick(titem.keyword)">{{titem.name}}</view>
									
								</view>
								<!-- 图片消息 -->
								<view v-if="row.msg.type=='image'" class="bubble img" @click="showPic(row.msg)">
									<text class="arrow-out"></text>
									<image :src="row.msg.content.url" style="width:140px;height:140px;"></image>
								</view>
								
								<!--小程序卡片-->
								<view v-if="row.msg.type=='miniprogrampage' && typeof( row.msg.content.miniprogrampage ) != 'undefined' " 
								class="bubble card"
								@click="cardClick(row.msg)">
									<text class="arrow-out"></text>
									<view class="title clamp">{{row.msg.content.miniprogrampage.Title}}</view>
									<view class="img" :style="{'background-image':'url('+row.msg.content.miniprogrampage.LocalUrl+')'}"></view>
									<view class="tips">小卡片</view>
								</view>
								
								<view class="username">
									<view class="name">{{row.msg.userinfo.username}}</view> 
									<view class="time">{{row.msg.time}}</view>
								</view>
							</view>
						</view>
					</block>
				</view>
			</scroll-view>
		</view>
		
		<!-- 抽屉栏 -->
		<view class="popup-layer" :class="popupLayerClass" @touchmove.stop.prevent="discard">
			<!-- 表情 --> 
			<swiper class="emoji-swiper" :class="{hidden:hideEmoji}" indicator-dots="true" duration="150">
				<swiper-item v-for="(page,pid) in emojiList" :key="pid">
					<view v-for="(em,eid) in page" :key="eid" @click="addEmoji(em)">
						<image mode="widthFix" :src="emHost+em.url"></image>
					</view>
				</swiper-item>
			</swiper>
			<!-- 更多功能 相册-拍照 -->
			<view class="more-layer" :class="{hidden:hideMore}">
				<view class="list">
					<view class="box" @click="chooseImage">
						<view class="icon tupian2"></view>
					</view>
					<view class="box" @click="camera">
						<view class="icon paizhao"></view>
					</view>
				</view>
			</view>
		</view>
		
		<!-- 底部输入栏 -->
		<view class="input-box" :class="popupLayerClass" @touchmove.stop.prevent="discard">
			<view class="more" @click="showMore">
				<view class="icon add"></view>
			</view>
			<view class="textbox">
				<view class="text-mode">
					<view class="box">
						<textarea auto-height="true" v-model="textMsg" @focus="textareaFocus"/>
					</view>
					<view class="em" @click="chooseEmoji">
						<view class="icon biaoqing"></view>
					</view>
				</view>
			</view>
			<view class="send" @click="sendText">
				<view class="btn">发送</view>
			</view>
		</view>
		
		<!--客服websocket 组件-->
		<kefuWebsocket ref="kefu-websocket" @on-message="workerMsg"></kefuWebsocket>
	</view>
</template>

<script>
import kefuWebsocket from './kefu-websocket.vue';

/**
 * 客服组件（小程序不用这个组件）
 */	
export default {
	components:{
		kefuWebsocket
	},
	data() {
		return {
			// 客服初始化信息
			info:{},
			
			//文字消息
			textMsg:'',
			
			//消息列表
			isHistoryLoading:false,
			scrollAnimation:false,
			scrollTop:0,
			scrollToView:'',
			msgList:[],
			msgImgList:[],
			
			// 当前用户的ID
			myuid:0,
			
			// 抽屉参数
			popupLayerClass:'',
			// more参数
			hideMore:true,
			//表情定义
			hideEmoji:true,
			emojiList:[],

			// 表情图片的url host
			emHost: '',
		};
	},
	onLoad(option) {
		this.init();
		this.initCard( option.type, option.id );
	},
	onShow(){
		this.scrollTop = 999999;
	},
	methods:{
		init(){
			// emoji 的host 地址
			this.emHost = this.$util.apiHost + '/../assets/emoji/';
			
			// 获取客服初始化信息，包括websocket 地址等
			this.$util.showLoading(this);
			
			// 客服初始化
			this.$u.post( this.$api.userKefuInit, {
			})
			.then( (response) => {
				this.$util.hideLoading();
				var res = response.data;
				if( res.code ){
					this.info = res.data;
					
					this.emojiList = this.info.emojiList;
					// 当前用户的ID
					this.myuid = this.info.userInfo.id;
					
					// 初始化 websocket
					this.$refs['kefu-websocket'].initData( this.info );

					// 初始化消息列表
					this.getMsgList( 0 );
				}
			});
		},
		// 初始化小卡片
		initCard( type, id ){
			switch( type ){
				case 'goods':
					
					break;
			}
			
			// 弹出卡片
		},
		// 接受消息(筛选处理)
		screenMsg(msg){
			//从长连接处转发给这个方法，进行筛选处理
			if(msg.type=='system'){
				// 系统消息
				switch (msg.msg.type){
					case 'text':
						this.addSystemTextMsg(msg);
						break;
				}
			}
			else if(msg.type=='user'){
				// 用户消息
				switch (msg.msg.type){
					// 文本
					case 'text':
						this.addTextMsg(msg);
						break;
						
					// 图片	
					case 'image':
						this.addImgMsg(msg);
						break;
						
					// 卡片	
					case 'miniprogrampage':
						this.addCardMsg(msg);
						break;
				}
				
				//非自己的消息震动
				if( msg.msg.userinfo.id != this.myuid ){
					console.log('振动');
					uni.vibrateLong();
				}
			}
			
			this.$nextTick( () => {
				// 滚动到底
				this.scrollToView = 'msg'+msg.msg.id
			});
		},
		//触发滑动到顶部(加载历史信息记录)
		loadHistory(e){
			if( this.isHistoryLoading || typeof(this.msgList[0].msg.isLast ) != 'undefined'){
				return ;
			}
			else{
				// 关闭滑动动画
				this.scrollAnimation = false;
				var lastId = this.msgList[0].msg.id;
				if( lastId != -100 ){
					this.getMsgList( lastId );
				}
			}
		},
		
		// 加载内容列表
		getMsgList( lastId ){
			this.isHistoryLoading = true;
			this.$u.post( this.$api.userKefuContentList, {
				last_id: lastId,
			})
			.then( (response) => {
				this.isHistoryLoading = false;
				var res = response.data;
				if( res.code ){
					// 消息列表
					let list = res.data.items;
					if( list.length == 0 ){
						uni.showToast({
							title:'没有更多内容了',
							icon:'none',
						});
						this.$set( this.msgList[0].msg, 'isLast', true );
						
						this.msgList.unshift({
							type: 'system',
							msg:{
								id: -100,
								type: 'text',
								content:{
									text: '没有更多内容了'
								}
							}
						});
						this.$nextTick( () => {
							this.scrollAnimation = true;//恢复滚动动画
						});
					}
					else{
						// 获取消息中的图片,并处理显示尺寸
						for(let i=0; i<list.length; i++){
							if( list[i].type =='user' && list[i].msg.type=="image" ){
								this.msgImgList.push( list[i].msg.content.url.replace(/\_thumb\.jpg/, '') );
							}
							else if( list[i].type =='user' && list[i].msg.type=="text" ){
								this.$set(list[i].msg, 'tags', []);
								list[i].msg.content.text = this.replaceEmoji( list[i].msg.content.text, list[i].msg.tags );
							}
						}
						
						if( lastId == 0 ){
							this.msgList = list;
							
							// 滚动到底部
							this.$nextTick( () => {
								//进入页面滚动到底部
								this.scrollTop = 99999;
								this.$nextTick( () => {
									this.scrollAnimation = true;
								});
							});
						}
						else{
							// 加载历史记录的
							for(var i in list){
								this.msgList.unshift( list[i] );
							}
							
							// 滚动到指定位置
							this.$nextTick( () => {
								this.scrollToView = 'msg' + lastId;
								this.$nextTick( () => {
									this.scrollAnimation = true;//恢复滚动动画
								});
							});
						}
					}
				}
			});
		},
		//更多功能(点击+弹出) 
		showMore(){
			this.hideEmoji = true;
			if(this.hideMore){
				this.hideMore = false;
				this.openDrawer();
			}else{
				this.hideDrawer();
			}
		},
		// 打开抽屉
		openDrawer(){
			this.popupLayerClass = 'showLayer';
		},
		// 隐藏抽屉
		hideDrawer(){
			this.popupLayerClass = '';
			setTimeout(()=>{
				this.hideMore = true;
				this.hideEmoji = true;
			},150);
		},
		// 选择图片发送
		chooseImage(){
			this.getImage('album');
		},
		//拍照发送
		camera(){
			this.getImage('camera');
		},
		
		//选照片 or 拍照
		getImage(type){
			this.hideDrawer();
			
			uni.chooseImage({
				sourceType:[type],
				sizeType: ['original', 'compressed'], //可以指定是原图还是压缩图，默认二者都有
				success: (res) => {
					for(let i=0; i<res.tempFilePaths.length; i++){
						uni.getImageInfo({
							src: res.tempFilePaths[i],
							success: (image) => {
								let msg = {
									url:res.tempFilePaths[i],
								};
	
								// ajax 把这张图片上传到服务器
								this.$util.showLoading( this );
								uni.uploadFile({
									url: this.$util.getUploadUrl( this ),
									filePath: res.tempFilePaths[i],
									name: 'file',
									formData: {
										'user': 'test'
									},
									success: ( uRes ) => {
										this.$util.hideLoading();
										var rs = JSON.parse( uRes.data );
										if( rs.code ){
											// 把上传成功的图片的url写入到内容
											msg.url = rs.data + '_thumb.jpg';
											this.sendMsg(msg,'image');
										}
										else{
											uni.showToast({
												title: '发送失败：'+ rs.message,
												icon: 'none',
											});
										}
									}
								});
							}
						});
					}
				}
			});
		},
		// 选择表情
		chooseEmoji(){
			this.hideMore = true;
			if(this.hideEmoji){
				this.hideEmoji = false;
				this.openDrawer();
			}
			else{
				this.hideDrawer();
			}
		},
		//添加表情
		addEmoji(em){
			this.textMsg+=em.alt;
		},
		
		//获取焦点，如果不是选表情ing,则关闭抽屉
		textareaFocus(){
			if(this.popupLayerClass=='showLayer' && this.hideMore == false){
				this.hideDrawer();
			}
		},
		// 发送文字消息
		sendText(){
			//隐藏抽屉
			this.hideDrawer();
			if( !this.textMsg ){
				uni.showToast({
					title:'内容不能为空',
					icon:'none',
				});
				return;
			}
			let msg = {
				text: this.replaceEmoji( this.textMsg ), 
			}
			this.sendMsg(msg, 'text', this.textMsg);
			//清空输入框
			this.textMsg = '';
		},

		// 发送消息
		sendMsg(content, type, text=''){
			var nowDate = new Date();
			let msg = {
				type:'user',
				msg:{
					id: nowDate.valueOf(),
					time: nowDate.getHours()+":"+nowDate.getMinutes(),
					type: type,
					userinfo:{
						id: this.info.userInfo.id,
						username: this.info.userInfo.wx_nick_name,
						face: this.info.userInfo.wx_avatar,
					},
					content: content,
				},
			}

			// 把用户的消息写入到交谈框
			this.screenMsg( msg );
			
			if( type == 'text' ){
				// text 发送未格式化过的数据
				content = {text:text};
			}
			
			// 发送用户消息到服务器
			this.$u.post( this.$api.userKefuContentAdd, {
				content_type: type,
				content: JSON.stringify(content),
				text: text,
			})
			.then( (response) => {
				var res = response.data;
				if( res.code ){
					
				}
			});
		},
		
		//替换表情符号为图片
		replaceEmoji(str, tags = [] ){
			let replacedStr = str.replace(/\[([^(\]|\[)]*)\]/g,(item, index)=>{
				for(let i=0;i<this.emojiList.length;i++){
					let row = this.emojiList[i];
					for(let j=0;j<row.length;j++){
						let EM = row[j];
						if(EM.alt==item){
							let imgstr = '<img src="'+ this.emHost + EM.url+'">';
							return imgstr;
						}
					}
				}
			});
			
			replacedStr = replacedStr.replace(/'/g,'"');
			replacedStr = replacedStr.replace(/keyword="([^\"]*)"/g, (item, index)=>{
				return 'style="display:none;" class="'+ item.replace('keyword="','');
			});
			
			replacedStr.replace(/class=([^\<]*)/g, (item, index)=>{
				var arr = item.split('">');
				tags.push({
					keyword: arr[0].replace('class="', '').replace('"', ''),
					name: arr[1],
				});
			});
			
			// 这里是富文本解析，是可以使用div 的
			return '<div style="word-wrap:break-word;">'+replacedStr+'</div>';
		},
		
		// 接收到客服回复的消息（提供给 ws 回调）
		workerMsg( obj ){
			// 统一处理ws 返回的信息
			switch( obj.action ){
				
				// 接收到客服的某条信息
				case 'csSession':
					// 替换emoji
					if( obj.data.content_type == 'text' ){
						this.$set(obj.data, 'tags', []);
						obj.data.content.text = this.replaceEmoji(obj.data.content.text, obj.data.tags );
					}
					else if( obj.data.content_type == 'image' ){
						this.msgImgList.push( obj.data.content.url.replace(/\_thumb\.jpg/, '') );
					}
					
					// 用客服回复的消息写入到交谈框
					this.screenMsg({
						type:'user',
						msg:{
							id: obj.data.content_id , // 内容ID
							time: obj.data.created_at_format,
							type: obj.data.content_type ,
							userinfo:{
								id: obj.data.worker.id,
								username: obj.data.worker.nick_name,
								face: obj.data.worker.avatar_format,
							},
							content: obj.data.content,
							tags: obj.data.tags,
						},
					});
					break;
				
				// 其它指令
				// case '':
			}
		},
		
		// 添加文字消息到列表
		addTextMsg(msg){
			this.msgList.push(msg);
		},
		// 添加图片消息到列表
		addImgMsg(msg){
			this.msgImgList.push(msg.msg.content.url);
			this.msgList.push(msg);
		},
		// 添加卡片消息到列表
		addCardMsg( msg ){
			this.msgList.push(msg);
		},
		// 添加系统文字消息到列表
		addSystemTextMsg(msg){
			this.msgList.push(msg);
		},
		sendSystemMsg(content,type){
			let lastid = this.msgList[this.msgList.length-1].msg.id;
			lastid++;
			let row = {type:"system",msg:{id:lastid,type:type,content:content}};
			this.screenMsg(row)
		},
		// 聊天内容中的 a 标签触发事件
		aTagClick( keyword ){
			let msg = {
				text: this.replaceEmoji( keyword ), 
			}
			this.sendMsg(msg, 'text', keyword );
		},
		// 预览图片
		showPic(msg){
			uni.previewImage({
				indicator:"none",
				current: msg.content.url.replace(/\_thumb\.jpg/, ''),
				urls: this.msgImgList
			});
		},
		// 点击了卡片
		cardClick( msg ){
			// 这里只提供给H5页面点击卡片
			if( msg.content.miniprogrampage != null ){
				// 跳转去H5 意见反馈
				if( msg.content.miniprogrampage.PagePath != null 
				&& msg.content.miniprogrampage.PagePath.indexOf('/pages/my/setting/feedback-form') !== -1 ){
					uni.navigateTo({
						url: msg.content.miniprogrampage.PagePath,
					})
				}
			}
		},
		discard(){
			return;
		}
	}
}
</script>