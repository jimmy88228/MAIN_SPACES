/*
* easy-http v1.1.0
* (c) 2018-2019 PengYuan-Jiang
*/
"use strict";function e(e,t){return null==e?e===t:e.constructor===t||e instanceof t}function t(e){if(e){let t,r=e.split(":");for(let e=0,s=r.length;e<s;e++){let s=r[e];s&&(t||(t=[])).push(s)}return t}}const r=/(?:{([^{}]*))?{\s*([a-z_][a-z0-9_]*)\s*((?::[a-z_][a-z0-9_]*)*)\s*}(?:([^{}]*)})?/gi,s={TEXT:"text",CMD:"cmd"},i=Symbol("privateScope");const a=class{constructor(e){this[i]={};let a=e;if(!a)return;let n,d,h=this[i].nodes=[],l=0;for(;d=r.exec(a);){n||(n=this[i].keys=[]);let e=d.index;l<e&&h.push({type:s.TEXT,data:a.substring(l,e)});let r=d[2],o=t(d[3])||void 0;h.push({type:s.CMD,data:{key:r,dictates:o||void 0,prefix:d[1]||void 0,suffix:d[4]||void 0}}),n[r]=1,l=e+d[0].length}let o=a.length;l<o&&h.push({type:s.TEXT,data:a.substring(l,o)})}get nodes(){return this[i].nodes}get keys(){return this[i].keys}toRequestTpl(){if(!this.nodes)return"";let e="";for(let t=0,r=this.nodes.length;t<r;t++){let r=this.nodes[t],i="";switch(r.type){case s.CMD:i=r.data.key,r.data.dictates&&(i=`${i}:${r.data.dictates.join(":")}`),i=`{${i}}`,(r.data.prefix||r.data.suffix)&&(i=`{${r.data.prefix||""}${i}${r.data.suffix||""}}`);break;case s.TEXT:default:i=r.data}e+=i}return e}},n=Symbol("privateScope");class d{constructor(r,s){if(this[n]={conf:r},s)if(e(s,Object)){let e;(e=s.method||s.m)&&(this[n].method=e),(e=s.urlFormat||s.u)&&(this[n].urlFormat=e),this[n].dictates=t(s.dictate||s.d)}else this[n].urlFormat=s}get baseUrl(){return this[n].conf.baseUrl||""}get method(){return this[n].method||this[n].conf.defaultMethod}get urlFormat(){return this[n].urlFormat}get dictates(){return this[n].dictates||this[n].conf.dictates}get odl(){return"odl"in this[n]||(this[n].odl=this.urlFormat&&new a(this.urlFormat)||void 0),this[n].odl}createUrl(e){let t=this.odl&&this.odl.nodes;e={...e||{}};let r="";for(let i=0,a=t&&t.length||0;i<a;i++){let a,n=t[i];switch(n.type){case s.TEXT:a=n.data;break;case s.CMD:let t=n.data,r=e[t.key];if(delete e[t.key],void 0===(r=this.dictateHandle(r,t.dictates)))continue;a=(t.prefix||"")+r+(t.suffix||"")}r+=a}let i,a=this.baseUrl+r;for(let t in e){let r=e[t];void 0!==(r=this.dictateHandle(r))&&(i=(i?i+"&":"")+t+"="+r)}return i&&(a+=(a.indexOf("?")<0?"?":"&")+i),a}dictateHandle(e,t){let r=this[n].conf;return e=r.serializater(e),(t||(t=this.dictates))&&t.forEach(t=>{let s=r.getDictateHandler(t);s&&(e=s(e))}),e}}class h{constructor(e,t=0){this.interceptors=e,this.index=t}proceed(e){if(this.index>=this.interceptors.length)throw"It's the last interceptor";let t=new h(this.interceptors,this.index+1);return this.interceptors[this.index](e,e=>t.proceed(e))}}const l="get",o=function(t){return e(t,Object)&&(t=JSON.stringify(t)),t},c=Symbol("privateScope");class u{constructor(){this[c]={}}init(e){e&&(this.setBaseUrl(e.baseUrl),this.setDefaultMethod(e.defaultMethod),this.setDictate(e.dictate),this.setHeaders(e.headers),this.setRequestHandler(e.requestHandler),this.setInterceptor(e.interceptors),this.setSerializater(e.serializater))}setBaseUrl(e){return this[c].baseUrl=e||void 0,this}setDefaultMethod(e){return this[c].defaultMethod=e,this}setDictate(e){return this[c].dictates=t(e),this}setHeaders(e){return this[c].headers=e?{...e}:void 0,this}addHeaders(e){return e?(this[c].headers?this[c].headers={...this[c].headers,...e}:this[c].headers={...e},this):this}removeHeaders(...e){this[c].headers&&e&&e.length>0&&e.forEach(e=>{e in this[c].headers&&delete this[c].headers[e]})}setRequestHandler(e){return this[c].requestHandler=e||void 0,this}setInterceptor(...e){e&&e.length>0?this[c].interceptors=[...e]:this[c].interceptors=null}addInterceptor(...e){return e&&e.length>0&&(this[c].interceptors||(this[c].interceptors=[]),this[c].interceptors.push(...e)),this}setDictateHandler(e){return this[c].dictateHandlers=e?{...e}:void 0,this}addDictateHandler(e){return e?(this[c].dictateHandlers?this[c].dictateHandlers={...this[c].dictateHandlers,...e}:this[c].dictateHandlers={...e},this):this}removeDictateHandler(...e){this[c].dictateHandlers&&e&&e.length>0&&e.forEach(e=>{e in this[c].dictateHandlers&&delete this[c].dictateHandlers[e]})}setSerializater(e){return this[c].serializater=e,this}}const f=new u;class p extends u{get getter(){if(this[c].getter)return this[c].getter;let e=this;return this[c].getter={get headers(){return e[c].headers||f[c].headers},get defaultMethod(){return(e[c].defaultMethod||f[c].defaultMethod||l).toLowerCase()},get dictates(){return e[c].dictates||f[c].dictates},get baseUrl(){return e[c].baseUrl||f[c].baseUrl},get serializater(){return e[c].serializater||f[c].serializater||o},get requestHandler(){return e[c].requestHandler||f[c].requestHandler},get interceptors(){return e[c].interceptors||f[c].interceptors},getDictateHandler:t=>e[c].dictateHandlers&&e[c].dictateHandlers[t]||f[c].dictateHandlers&&f[c].dictateHandlers[t]},this[c].getter}}const g=[],H=[],b=Symbol("privateScope");class m{constructor(e,t){this[b]={conf:new p},this.setBaseUrl(e).addRequests(t)}request(e){if(!e)throw"req is required";let t=this[b].conf.getter,r=t.requestHandler;if(!r)throw"requestHandler has not been set yet";let s,i=[...t.interceptors||g,e=>r(e)],a=new h(i);return s=e.coverHeaders?e.headers||H:{...t.headers||H,...e.headers||H},a.proceed({url:e.url||"",method:e.method||"",data:e.data,headers:s,extraData:e.extraData})}createHandler(e){let t=r=>{let s,i,a,n,d,h;return i=e.method,r?(s=t.getUrl(r.params),a=r.data,n=r.headers,d=r.coverHeaders,h=r.extraData):s=t.getUrl(),this.request({url:s,method:i,data:a,headers:n,coverHeaders:d,extraData:h})};return t.getUrl=function(t){return e.createUrl(t)},t}}Object.defineProperty(m.prototype,"addRequests",{configurable:!1,enumerable:!1,get:function(){return function(e){if(!e)return this;for(let t in e){let r=new d(this[b].conf.getter,e[t]);Object.defineProperty(this,t,{get:function(){return this.createHandler(r)}})}return this}.bind(this)}});const y=["init","setBaseUrl","setDefaultMethod","setDictate","setHeaders","addHeaders","removeHeaders","setRequestHandler","setInterceptor","addInterceptor","setDictateHandler","addDictateHandler","removeDictateHandler","setSerializater"],v=y.length;for(let e=0;e<v;e++){let t=y[e];Object.defineProperty(m,t,{configurable:!1,enumerable:!1,get:function(){return function(){return f[t](...arguments),this}.bind(this)}}),Object.defineProperty(m.prototype,t,{configurable:!1,enumerable:!1,get:function(){return function(){return this[b].conf[t](...arguments),this}.bind(this)}})}module.exports=m;