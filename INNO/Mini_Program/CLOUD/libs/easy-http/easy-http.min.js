/*!
* easy-http.js v1.0.1
* (c) 2018-2018 PengYuan-Jiang
*/
import Promise from "../promise/promise.js"
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.EasyHttp=e()}(this,function(){"use strict";function t(t,e){return void 0==t?t===e:t.constructor===e||t instanceof e}var e=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(t[s]=r[s])}return t};function r(t){if(t){let e;return t.split(":").forEach(t=>{t&&(e||(e=new Array),e.push(t))}),e}}function s(e){return t(e,Object)&&(e=JSON.stringify(e)),e}class i{setBaseUrl(t){return this.baseUrl=t||"",this}setHeader(t){return this.h=t?e({},t):null,this}addHeader(t){return t?(this.h=this.h?e({},this.h,t):e({},t),this):this}bindHandler(t){return this.hd=t,this}bindPreHandler(){let t=arguments;return t&&t.length>0&&(this.prehd||(this.prehd=[]),this.prehd.push(...t)),this}bindPostHandler(){let t=arguments;return t&&t.length>0&&(this.posthd||(this.posthd=[]),this.posthd.push(...t)),this}bindDictate(t,e){return t&&e&&(this.dm||(this.dm={}),this.dm[t.toLowerCase()]=e),this}setAction(t){return this.defA=t,this}setDictate(t){return this.defD=r(t),this}setSerializater(t){return this.sz=t,this}setErrorHandler(t){return this.eh=t,this}setEscape(t){return this.esc=t,this}use(t){return t.install(this),this}}const n=new i;class a{constructor(t){this.outConf=t}get header(){let t=this.outConf.h||n.h;return t?e({},t):{}}set escape(t){t&&(this.esc=t)}get escape(){return void 0!=this.esc?this.esc:void 0!=this.outConf.esc?this.outConf.esc:void 0!=n.esc&&n.esc}set dictate(t){this.defD=r(t)}get dictate(){return this.defD||this.outConf.defD||n.defD}set action(t){this.defA=t}get action(){return(this.defA||this.outConf.defA||n.defA||"get").toLowerCase()}get baseUrl(){return this.outConf.baseUrl||n.baseUrl}get serializater(){return this.outConf.sz||n.sz||s}get errorHandler(){return this.outConf.eh||n.eh}get handler(){return this.outConf.hd||n.hd}get preHandlers(){return this.outConf.prehd||n.prehd}get postHandlers(){return this.outConf.posthd||n.posthd}dictateMap(t){return this.outConf.dm&&this.outConf.dm[t]||n.dm&&n.dm[t]}}const h=/(?:\[([^[{]*))?{\s*([a-z_][a-z0-9_]*)\s*((?::[a-z_][a-z0-9_]*)*)\s*}(?:([^}\]]*)\])?/gi,o="*:hold-bl:*",l="*:hold-br:*",u="*:hold-ml:*",c="*:hold-mr:*";class d extends a{constructor(e,r){super(e),r&&(t(r,Object)?((r.action||r.a)&&(this.action=r.action||r.a),(r.urlFormat||r.u)&&(this._urlFormat=r.urlFormat||r.u),(r.escape||r.esc)&&(this.escape=r.escape||r.esc),this.dictate=r.dictate||r.d):this._urlFormat=r)}get urlFormat(){return this._urlFormatHold||this._urlFormat}reSetUrlFormat(){var t;this.escape?this._urlFormatHold||(this._urlFormatHold=(t=this._urlFormat)?t.replace("\\{",o).replace("\\}",l).replace("\\[",u).replace("\\]",c):t):this._urlFormatHold&&delete this._urlFormatHold,this.makeMatchsMap()}makeMatchsMap(){if(!this.matchsMap||this._matchsUrl!==this.urlFormat){let t;for(this.matchsMap={},this._matchsUrl=this.urlFormat;null!=(t=h.exec(this._matchsUrl));){let e={match:t[0],prefix:t[1],key:t[2],suffix:t[4]};if(t[3]){t[3].split(":").forEach(t=>{t&&(e.dictate||(e.dictate=new Array),e.dictate.push(t))})}this.matchsMap[e.key]=e}}return this.matchsMap}recoverUrl(t){return this._urlFormatHold?(e=t)?e.replace(o,"{").replace(l,"}").replace(u,"[").replace(c,"]"):e:t;var e}analysis(t){let e;this.reSetUrlFormat(),t||(t={});let r=this.urlFormat,s=this.matchsMap;if(s)for(let e in s)if(!(e in t)){let t=s[e];r=r.replace(t.match,"")}for(let i in t){let n=s[i],a=t[i],h=this.serializater;a=h(a);let o=n&&n.dictate||this.dictate;o&&o.forEach(t=>{let e=this.dictateMap(t);e&&(a=e(a))});let l=void 0===a;n?(a=l?"":(n.prefix||"")+a+(n.suffix||""),r=r.replace(n.match,a)):(l&&(a=""),e||(e=""),e+=(e?"&":"")+i+"="+a)}r=r?this.recoverUrl(r):"";let i=this.baseUrl+r;return e&&(i+=(i.indexOf("?")<0?"?":"&")+e),i}}var f=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(t[s]=r[s])}return t};class p{constructor(t){this.ro=t}get handler(){return this.createHandler()}createHandler(){let t,e=this,r=function(t){let s=new Promise((s,i)=>{let n=r.getUrl(t&&t.params),a=e.ro.action,h={url:n,params:t&&t.params,action:a,data:t&&t.data,other:t&&t.other,header:t.header?f({},r.getHeader(),t.header):r.getHeader()},o=e.ro.handler;if(o){let t=e.ro.preHandlers;if(t&&t.length>0)for(let e=0,r=t.length;e<r;e++)if(t[e](h,s,i))return;try{o(h).then(t=>{s({request:h,response:t})}).catch(t=>{i({errType:0,request:h,response:t})})}catch(t){i({errType:-1,request:h,msg:t})}}else i({errType:-1,request:h,msg:"not found handler"})}),i=e.ro.postHandlers;return i&&i.length>0?Promise.resolve().then(()=>{let t=s;for(let e=0,r=i.length;e<r;e++)t=i[e](t);return t}):s};return r.setHeader=function(e){return t=e?f({},e):null,r},r.addHeader=function(e){return e?(t=f({},this.getHeader(),e),r):r},r.getHeader=function(){return t||e.ro.header},r.getUrl=function(t){return e.ro.analysis(t)},r}}const[m,g,b,H]=[Symbol("requestOptions"),Symbol("requesters"),Symbol("configure"),Symbol("getRequestItem")];class y{constructor(t,e){this[b]=new i,this.setBaseUrl(t).addRequests(e)}[H](t){return this[g]||(this[g]={}),t in this[m]&&!(t in this[g])&&(this[g][t]=new p(this[m][t])),this[g]&&this[g][t]}}Object.defineProperty(y.prototype,"addRequests",{configurable:!1,enumerable:!1,get:function(){return function(t){if(t){this[m]||(this[m]={});for(let e in t)this[m][e]=new d(this[b],t[e]),Object.defineProperty(this,e,{get:function(){let t=this[H](e);return t&&t.handler}})}return this}.bind(this)}});const v=["setBaseUrl","setHeader","addHeader","bindHandler","bindPreHandler","bindPostHandler","bindDictate","setSerializater","setErrorHandler","setAction","setDictate","setEscape","use"],F=v.length;for(let t=0;t<F;t++){let e=v[t];Object.defineProperty(y,e,{configurable:!1,enumerable:!1,get:function(){return function(){return n[e](...arguments),this}.bind(this)}}),Object.defineProperty(y.prototype,e,{configurable:!1,enumerable:!1,get:function(){return function(){return this[b][e](...arguments),this}.bind(this)}})}return y});