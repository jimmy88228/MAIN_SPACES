var CHAR_TILDE=126,CODE_FNC1=102,SET_STARTA=103,SET_STARTB=104,SET_STARTC=105,SET_SHIFT=98,SET_CODEA=101,SET_CODEB=100,SET_STOP=106,REPLACE_CODES={CHAR_TILDE:CODE_FNC1},CODESET={ANY:1,AB:2,A:3,B:4,C:5};function getBytes(str){for(var bytes=[],i=0;i<str.length;i++)bytes.push(str.charCodeAt(i));return bytes}function stringToCode128(text){var barc={currcs:CODESET.C},bytes=getBytes(text),index=bytes[0]==CHAR_TILDE?1:0,csa1=bytes.length>0?codeSetAllowedFor(bytes[index++]):CODESET.AB,csa2=bytes.length>0?codeSetAllowedFor(bytes[index++]):CODESET.AB;barc.currcs=getBestStartSet(csa1,csa2),barc.currcs=perhapsCodeC(bytes,barc.currcs);var codes=new Array;switch(barc.currcs){case CODESET.A:codes.push(SET_STARTA);break;case CODESET.B:codes.push(SET_STARTB);break;default:codes.push(SET_STARTC)}for(var i=0;i<bytes.length;i++){var b1=bytes[i];b1 in REPLACE_CODES&&(codes.push(REPLACE_CODES[b1]),b1=bytes[++i]);var b2=bytes.length>i+1?bytes[i+1]:-1;codes=codes.concat(codesForChar(b1,b2,barc.currcs)),barc.currcs==CODESET.C&&i++}for(var checksum=codes[0],weight=1;weight<codes.length;weight++)checksum+=weight*codes[weight];return codes.push(checksum%103),codes.push(SET_STOP),codes;function getBestStartSet(csa1,csa2){var vote=0;return vote+=csa1==CODESET.A?1:0,vote+=csa1==CODESET.B?-1:0,vote+=csa2==CODESET.A?1:0,(vote+=csa2==CODESET.B?-1:0)>0?CODESET.A:CODESET.B}function perhapsCodeC(bytes,codeset){for(var i=0;i<bytes.length;i++){var b=bytes[i];if((b<48||b>57)&&b!=CHAR_TILDE)return codeset}return CODESET.C}function codesForChar(chr1,chr2,currcs){var result=[],shifter=-1;if(charCompatible(chr1,currcs))currcs==CODESET.C&&(-1==chr2?(shifter=SET_CODEB,currcs=CODESET.B):-1==chr2||charCompatible(chr2,currcs)||(charCompatible(chr2,CODESET.A)?(shifter=SET_CODEA,currcs=CODESET.A):(shifter=SET_CODEB,currcs=CODESET.B)));else if(-1==chr2||charCompatible(chr2,currcs))shifter=SET_SHIFT;else switch(currcs){case CODESET.A:shifter=SET_CODEB,currcs=CODESET.B;break;case CODESET.B:shifter=SET_CODEA,currcs=CODESET.A}return-1!=shifter?(result.push(shifter),result.push(codeValue(chr2))):currcs==CODESET.C?result.push(codeValue(chr1,chr2)):result.push(codeValue(chr1)),barc.currcs=currcs,result}}function codeValue(chr1,chr2){return void 0===chr2?chr1>=32?chr1-32:chr1+64:parseInt(String.fromCharCode(chr1)+String.fromCharCode(chr2))}function charCompatible(chr,codeset){var csa=codeSetAllowedFor(chr);return csa==CODESET.ANY||(csa==CODESET.AB||(csa==CODESET.A&&codeset==CODESET.A||csa==CODESET.B&&codeset==CODESET.B))}function codeSetAllowedFor(chr){return chr>=48&&chr<=57?CODESET.ANY:chr>=32&&chr<=95?CODESET.AB:chr<32?CODESET.A:CODESET.B}exports.code128=function(ctx,text,width,height){width=parseInt(width),height=parseInt(height);for(var codes=stringToCode128(text),g=new Graphics(ctx,width,height),barWeight=g.area.width/(11*(codes.length-3)+35),x=g.area.left,y=g.area.top,i=0;i<codes.length;i++)for(var c=codes[i],bar=0;bar<8;bar+=2){var barW=PATTERNS[c][bar]*barWeight,barH=height-y,spcW=PATTERNS[c][bar+1]*barWeight;barW>0&&g.fillFgRect(x,y,barW,barH),x+=barW+spcW}ctx.draw()};var Graphics=function(ctx,width,height){this.width=width,this.height=height,this.quiet=Math.round(this.width/40),this.border_size=0,this.padding_width=0,this.area={width:width-2*this.padding_width-2*this.quiet,height:height-2*this.border_size,top:this.border_size-4,left:this.padding_width+this.quiet},this.ctx=ctx,this.fg="#000000",this.bg="#ffffff",this.fillBgRect(0,0,width,height),this.fillBgRect(0,this.border_size,width,height-2*this.border_size)};Graphics.prototype._fillRect=function(x,y,width,height,color){this.ctx.setFillStyle(color),this.ctx.fillRect(x,y,width,height)},Graphics.prototype.fillFgRect=function(x,y,width,height){this._fillRect(x,y,width,height,this.fg)},Graphics.prototype.fillBgRect=function(x,y,width,height){this._fillRect(x,y,width,height,this.bg)};var PATTERNS=[[2,1,2,2,2,2,0,0],[2,2,2,1,2,2,0,0],[2,2,2,2,2,1,0,0],[1,2,1,2,2,3,0,0],[1,2,1,3,2,2,0,0],[1,3,1,2,2,2,0,0],[1,2,2,2,1,3,0,0],[1,2,2,3,1,2,0,0],[1,3,2,2,1,2,0,0],[2,2,1,2,1,3,0,0],[2,2,1,3,1,2,0,0],[2,3,1,2,1,2,0,0],[1,1,2,2,3,2,0,0],[1,2,2,1,3,2,0,0],[1,2,2,2,3,1,0,0],[1,1,3,2,2,2,0,0],[1,2,3,1,2,2,0,0],[1,2,3,2,2,1,0,0],[2,2,3,2,1,1,0,0],[2,2,1,1,3,2,0,0],[2,2,1,2,3,1,0,0],[2,1,3,2,1,2,0,0],[2,2,3,1,1,2,0,0],[3,1,2,1,3,1,0,0],[3,1,1,2,2,2,0,0],[3,2,1,1,2,2,0,0],[3,2,1,2,2,1,0,0],[3,1,2,2,1,2,0,0],[3,2,2,1,1,2,0,0],[3,2,2,2,1,1,0,0],[2,1,2,1,2,3,0,0],[2,1,2,3,2,1,0,0],[2,3,2,1,2,1,0,0],[1,1,1,3,2,3,0,0],[1,3,1,1,2,3,0,0],[1,3,1,3,2,1,0,0],[1,1,2,3,1,3,0,0],[1,3,2,1,1,3,0,0],[1,3,2,3,1,1,0,0],[2,1,1,3,1,3,0,0],[2,3,1,1,1,3,0,0],[2,3,1,3,1,1,0,0],[1,1,2,1,3,3,0,0],[1,1,2,3,3,1,0,0],[1,3,2,1,3,1,0,0],[1,1,3,1,2,3,0,0],[1,1,3,3,2,1,0,0],[1,3,3,1,2,1,0,0],[3,1,3,1,2,1,0,0],[2,1,1,3,3,1,0,0],[2,3,1,1,3,1,0,0],[2,1,3,1,1,3,0,0],[2,1,3,3,1,1,0,0],[2,1,3,1,3,1,0,0],[3,1,1,1,2,3,0,0],[3,1,1,3,2,1,0,0],[3,3,1,1,2,1,0,0],[3,1,2,1,1,3,0,0],[3,1,2,3,1,1,0,0],[3,3,2,1,1,1,0,0],[3,1,4,1,1,1,0,0],[2,2,1,4,1,1,0,0],[4,3,1,1,1,1,0,0],[1,1,1,2,2,4,0,0],[1,1,1,4,2,2,0,0],[1,2,1,1,2,4,0,0],[1,2,1,4,2,1,0,0],[1,4,1,1,2,2,0,0],[1,4,1,2,2,1,0,0],[1,1,2,2,1,4,0,0],[1,1,2,4,1,2,0,0],[1,2,2,1,1,4,0,0],[1,2,2,4,1,1,0,0],[1,4,2,1,1,2,0,0],[1,4,2,2,1,1,0,0],[2,4,1,2,1,1,0,0],[2,2,1,1,1,4,0,0],[4,1,3,1,1,1,0,0],[2,4,1,1,1,2,0,0],[1,3,4,1,1,1,0,0],[1,1,1,2,4,2,0,0],[1,2,1,1,4,2,0,0],[1,2,1,2,4,1,0,0],[1,1,4,2,1,2,0,0],[1,2,4,1,1,2,0,0],[1,2,4,2,1,1,0,0],[4,1,1,2,1,2,0,0],[4,2,1,1,1,2,0,0],[4,2,1,2,1,1,0,0],[2,1,2,1,4,1,0,0],[2,1,4,1,2,1,0,0],[4,1,2,1,2,1,0,0],[1,1,1,1,4,3,0,0],[1,1,1,3,4,1,0,0],[1,3,1,1,4,1,0,0],[1,1,4,1,1,3,0,0],[1,1,4,3,1,1,0,0],[4,1,1,1,1,3,0,0],[4,1,1,3,1,1,0,0],[1,1,3,1,4,1,0,0],[1,1,4,1,3,1,0,0],[3,1,1,1,4,1,0,0],[4,1,1,1,3,1,0,0],[2,1,1,4,1,2,0,0],[2,1,1,2,1,4,0,0],[2,1,1,2,3,2,0,0],[2,3,3,1,1,1,2,0]];