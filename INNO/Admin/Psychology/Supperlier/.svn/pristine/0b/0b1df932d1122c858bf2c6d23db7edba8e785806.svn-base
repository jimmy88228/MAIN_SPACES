<template>
<div class="">
  <custom-modal class="choose-problem-modal hold-modal-zindex" ref="modal" :width="620" :closable="true" :isSlotHeader="true" :isSlotFooter="true">
    <div slot="header">选择管理范围()</div>
    <div class="choose-problem-cont _choose-problem-cont">
      <searchForm :searchForm="searchForm" :modelId="modelId" :hasDimensions="hasDimensions" @search="loadData()"></searchForm>
      <!-- <Table
      ref="myTable"
      class="full-table"
      :columns="columns"
      :data="list"
      :height="300"
      border
      :loading="tableLoading"
      @on-row-click="rowClick"
      >
        <template slot="dimension" slot-scope="{ row }">
            <div>
              <span v-for="(item, index) in row.dimensionsData" :key="item.id">{{item.name}}<span v-if="index < row.dimensionsData.length - 1">,</span></span>
            </div>
        </template>
        <template slot="handle" slot-scope="{ row }">
          <div class="operate-area">
            <Checkbox :value="ids.indexOf(row.id) != -1" @on-change="changeChoose(row)">{{row.dimension_name}}</Checkbox>
          </div>
        </template>
      </Table> -->
      <div class="problem-table">
        <div class="p-table-header">
          <div class="p-table-tr">
            <div class="p-table-th" :style="tdStyle(cItem)" v-for="(cItem, cIndex) in columns" :key="cIndex">
              {{cItem.title}}
            </div>
          </div>
        </div>
        <div class="p-table-body" @mouseleave="hoverLeave()">
          <div v-bar style="height: 300px;">
            <div class="p-table-tr" @mouseenter="trHover(lItem, lIndex)"  :style="trSelectStyle(lItem, lIndex)" @click="rowClick(lItem, lIndex)" v-for="(lItem, lIndex) in list" :key="lIndex">
              <div class="p-table-td" :style="tdStyle(cItem)" v-for="(cItem, cIndex) in columns" :key="cIndex">
                <template v-if="cItem.type == 'index'">
                  {{lIndex + 1}}
                </template>
                <template v-if="cItem.slot == 'dimension'">
                    <div>
                      <span v-for="(item, index) in lItem.dimensionsData" :key="item.id">{{item.name}}<span v-if="index < lItem.dimensionsData.length - 1">,</span></span>
                    </div>
                </template>
                <template  v-else-if="cItem.slot == 'handle'">
                  <div class="operate-area">
                    <Checkbox :value="ids.indexOf(lItem.id) != -1" @on-change="changeChoose(lItem)">{{lItem.dimension_name}}</Checkbox>
                  </div>
                </template>
                <template v-else>
                  {{cItem.key && lItem[cItem.key]}}
                </template>
              </div>
            </div>
          </div>
        </div>
      </div>
      <rewrite-page
        slot="footer"
        :total="total"
        :current="page"
        :page-size="pageSize"
        :page-size-opts="pageSizeOpts"
        @on-change="(e) => loadData(e)"
        @on-page-size-change="handlePageSizeChange"
        show-sizer
        show-elevator
        show-total
        transfer
      ></rewrite-page>
    </div>
    <div slot="footer">
      <Button @click="dismiss">取消</Button>
      <Button type="primary" @click="confirm()">保存</Button>
    </div>
    <Spin fix v-if="pageLoading"></Spin>
  </custom-modal>
</div>
</template>

<script>

import ListMixin from "@/helper/mixin/list-mixin";
import mixins from "./mixins.js";
import searchForm from "./search-form.vue";
export default {
  mixins: [ ListMixin, mixins ],
  components: {
    searchForm
  },
  props: {
    modelId: {
      type: Number | String,
      default: 0
    },
    problemsData: {
      type: Array,
      default: ()=>{
        return []
      }
    },
  },
  data(){
    return {
      searchForm: {
        state: 0,
        dimensions: []
      },
      chooseProblem: [],
      isLocked: false,
      hasDimensions: [],
      clickOperate: {
        start: -1,
        hover: -1,
        end: -1
      }
    }
  },
  computed: {
    ids(){
      let chooseProblem = this.chooseProblem || [];
      let ids = []
      chooseProblem.map((item)=>{
        if(item.id){
          ids.push(item.id)
        }
      })
      return ids;
    }
  },
  methods: {
    dismiss() {
      this.$refs.modal.dismiss();
    },
    showModal({ chooseProblem = [] }){
      this.chooseProblem = JSON.parse(JSON.stringify(chooseProblem || []));
      this.searchForm = {
        state: 0,
        dimensions: []
      }
      this.isLocked = false;
      this.loadData();
      this.$refs.modal.show();
    },
    onLoadData(page, extraData) {
      return new Promise((rs, rj)=>{
        let page = Number(extraData.page) || 1;
        let pageSize = Number(extraData.pageSize);
        let problemsData = JSON.parse(JSON.stringify(this.problemsData || []));
        let data = [];
        let searchForm = this.searchForm || {};
        let installData = [];
        let hasDimensions = [];
        problemsData.map((item)=>{
          let hasPush = false, isHasDimension = false;
          let iDimensions = item.dimensions || [];
          if(!(!iDimensions.length ||  (iDimensions.length == 1 && iDimensions[0] == 0))){
            isHasDimension = true;
          }
          delete problemsData.option_data;
          if(searchForm.state == -1){
            hasPush = true;
          }else if(searchForm.state){
            let sDimensions = searchForm.dimensions || [];
            if(sDimensions.length){
              if(isHasDimension){
                if((sDimensions.length + iDimensions.length) !== Array.from(new Set([...sDimensions,...iDimensions])).length){
                  hasPush = true;
                }
              }
            } else if(isHasDimension){
                hasPush = true;
              }
          } else if(!isHasDimension){
            hasPush = true;
          }
          if(hasPush){
            installData.push(item);
          }
          if(!this.isLocked){
            hasDimensions = Array.from(new Set([...hasDimensions,...iDimensions]));
          }
        })
        if(!this.isLocked){
          this.hasDimensions = hasDimensions;
          this.isLocked = true;
        }
        data = installData.slice((page - 1) * pageSize, page * pageSize)
        this.data = {
          total: installData.length,
          list: data
        };
        console.log("data", data)
        return rs();
      })
    },
    tdStyle(item){
      let style = "";
      if(item.width){
        style = style + "max-width:" + item.width + "px;"
      }
      if(item.minWidth){
        style = style + "min-width:" + item.minWidth + "px;"
      }
      return style
    },
    rowClick(row, index){
      let clickOperate = this.clickOperate || {};
      if(clickOperate.start == -1 || clickOperate.end > -1){
        this.clickOperate.start = index;
        this.clickOperate.hover = -1;
        this.clickOperate.end = -1;
      } else if(clickOperate.start > -1){
        this.clickOperate.end = index;
        this.clickOperate.hover = index;
      }
    },
    trHover(row, index){
      let clickOperate = this.clickOperate || {};
      if(clickOperate.start == -1 || clickOperate.end > -1){ return; }
      this.clickOperate.hover = index;
    },
    hoverLeave(){
      console.log("离开",this.clickOperate)
      if(this.clickOperate.end == -1){
        this.clickOperate.hover = -1;
      }
    },
    trSelectStyle(row, index){
      return "";
      let {start, hover, end} = this.clickOperate || {};
      if(start == -1){
        return "";
      }
      if(start == index || end == index){
        return "background-color:#348DED;color:#fff;"
      }
      if(hover == -1) {
        return "";
      }
      if(hover > start){
        if(hover > index && index > start){
          return "background-color:#E1F0FD"
        }
      } 
      if(hover < start){
        if(hover < index && index < start){
          return "background-color:#E1F0FD"
        }
      }
      return "";
    },
    changeChoose(row){
      let index = this.ids.indexOf(row.id);
      if(index == -1){
        this.chooseProblem.push(row);
      } else {
        this.chooseProblem.splice(-1, 1);
      }
    },
    confirm(){
      if(!this.chooseProblem.length){
        this.$Message.warning("请选择问题");
        return;
      }
      this.$emit("chooseProblem", this.chooseProblem);
      this.dismiss();
    },
  }
}
</script>

<style lang="less" scoped>
.choose-problem-modal{
  .add-dimension{
    width: 124px;
    height: 40px;
    background: #ECF8FE;
    font-size: 14px;
    font-family: PingFangSC-Regular, PingFang SC;
    font-weight: 400;
    color: #008ACB;
    line-height: 20px;
    margin-bottom: 10px;
  }
  .dimension-item{
    display: inline-block;
    width: 166px;
    margin-right:10px;
    margin-bottom: 18px;
  }
  .choose-problem-cont{
    margin: -10px;
    margin-bottom: -30px;
  }
  .problem-table{
    .p-table-tr{
      display: flex;
      width:100%;
      align-items: center;
      background-color:#fff;
      border-bottom: 1px solid #e8eaec;
      transition: all .35s;
      min-height: 48px;
      cursor: pointer;
    }
    .p-table-tr:hover{
      background-color:#EBF7FF;
    }
  }
  .p-table-header{
    .p-table-tr{
      border-top: 1px solid #e8eaec;
    }
    .p-table-tr:hover{
      background:none;
    }
    .p-table-th{
      min-width: 0;
      text-align: left;
      text-overflow: ellipsis;
      vertical-align: middle;
      font-size: 14px;
      color: #B2B2B2;
      position: relative;
      padding: 8px 5px;
      border-right: 0px;
      border-color: #F2F2F2;
      flex: 1;
      flex-shrink: 0;
    }
  }
  .p-table-body{
    
    .p-table-td{
      min-width: 0;
      box-sizing: border-box;
      text-align: left;
      text-overflow: ellipsis;
      vertical-align: middle;
      padding: 8px 5px;
      flex: 1;
      flex-shrink: 0;
    }
  }
  
}
</style>
<style lang="less">
._choose-problem-cont{
  .ivu-form-item-error-tip{
    padding-top: 2px;
  }
}

</style>