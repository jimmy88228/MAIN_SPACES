<template>
  <hold-layout :isFull="true" class="edit-gauge" isShowFormSave @_cancel="cancel" @_save="save">
    <Tabs :value="curTab" @on-click="changeTab" name="editGauge">
      <TabPane label="基础信息" name="basic" tab="editGauge">
        <Form
          class="box"
          :label-width="80"
          ref="formId"
          :model="formData"
          :rules="ruleValidate"
        >
          <FormItem label="量表名称" prop="model_name">
            <custom-input 
              style="width:260px"
              v-model="formData.model_name"
              type="text"
              placeholder=""
              :maxlength="30"
            ></custom-input>
          </FormItem>
          <FormItem label="指导语" prop="instruction">
            <custom-input 
              style="width:260px"
              v-model="formData.instruction"
              type="text"
              placeholder="指导语不超过40个字符"
              :maxlength="40"
              :show-word-limit="true"
            ></custom-input>
          </FormItem>
          <FormItem label="活动引语" prop="description">
            <custom-input 
              style="width:260px"
              v-model="formData.description"
              type="textarea"
              placeholder="活动引语不超过150个字符"
              :maxlength="150"
              :rows="9"
              :show-word-limit="true"
            ></custom-input>
          </FormItem>
        </Form>
      </TabPane>
      <TabPane label="报告建议" name="report" tab="editGauge">
        <report ref="report" class="box"></report>
      </TabPane> 
      <!-- <TabPane label="题目管理" name="manager" tab="editGauge"></TabPane> -->
    </Tabs>
  </hold-layout>
</template>

<script>
import report from "./report.vue"
export default {
  mixins: [],
  components: {
    report
  },
  data() {
    return {
      ruleValidate: {
        model_name: [
            {
                required: true,
                validator: this._checkString,
                message: "量表名称不能为空",
                trigger: "blur",
            },
        ],
      },
      formData:{
        model_name:"",
        instruction:"",
        description:"",
      },
      pageId:0,
      curTab: "basic",
    };
  },
  methods: {
    init(){
        if(!this.pageId)return  
        this.getInfoApi('scaleInfo',this.pageId).then(res=>{
            let data = res.data||{};
            let items = data.items ||{};
            let {model_name,instruction,description} = items;
            this.formData.model_name = model_name||"";
            this.formData.instruction = instruction||"";
            this.formData.description = description||""; 
        })
    },
    getInfoApi(url,id){
        return this.$MainApi[url]({
            data: {
                id: this.pageId,
            }, 
        })
        .then((res) => {
            if (res.code) {
                return res
            }else{
                return Promise.reject(res);
            }
        })
    },
    changeTab(name) {
      this.curTab = name;
    },
    cancel(){
        console.log('cancel');
        this.$router.back();
    },
    save(){
        this.$refs.formId.validate((valid) => {
            if (valid) {
                this.scaleUpdate().then(()=>{
                    this.$refs.report.clickSave();
                })
            }else{
                this.curTab = 'basic';
                this.$Message.info("请完善基础信息");
            }
        })
    },
    scaleUpdate(){
        return this.$MainApi.scaleUpdate({
            data: {
                id: this.pageQuery.id||0,
                ...this.formData,
                description:this.formData.description.slice(0,150),
                instruction:this.formData.instruction.slice(0,40),
                model_name:this.formData.model_name.slice(0,30),
            }, 
        })
        .then((res) => {
            if (res.code) {
                return res
            }else{
                this.curTab = 'basic';
                this.$Message.info(res.message||"请完善基础信息");
                return Promise.reject(res);
            }
        })
    },
  },
  mounted () {
    this.pageId = parseInt(this.pageQuery.id||0);
    this.init();
  },
};
</script>

<style lang="less" scoped>
.edit-gauge{
    .box{
        padding-top: 40px;
        height: 100%;
    }
}
</style>
<style lang="less">
.edit-gauge{
    .ivu-tabs{
        height: 100%;
    }
    .ivu-tabs-content{
        height: calc(100% - 52px);
    }
}
</style>