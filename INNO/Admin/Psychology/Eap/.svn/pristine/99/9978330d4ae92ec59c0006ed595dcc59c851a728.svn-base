<template>
  <div class="material-box flex1 flex flex-col" :class="{'left':isShowTabs&&isShowClassify,'onlyTabs':isShowTabs&&!isShowClassify,'isSticky':fromType=='contentRepository'}">
    <div class="tabs" :class="{'isBorder':isShowSourceBox}" v-if="isShowTabs">
      <div class="tab-item pointer flex-c-c" :class="{'active':curTabIndex == index}" v-for="(item,index) in tabList" :key="item.id" @click="onChangeTap('curTabIndex',index)">
        {{item.name}}
      </div>
    </div>
    <div class="content-box flex1" :class="{'classify':isShowClassify,'tipsBox':isShowTipsBox||isShowSourceBox}">
      <div class="filter-box" v-if="isShowClassify || isShowTipsBox || isShowSourceBox">
        <div class="classify-box flex-s-c" v-if="isShowClassify">
          <div class="classify-item flex-s-c pointer" :class="{'active':curClassifyIndex == index}" v-for="(item,index) in classifyList" :key="item.id" @click="onChangeTap('curClassifyIndex',index)">
            {{item.name}}
          </div>
        </div>
        <div class="flex-b-c" v-if="isShowTipsBox">
          <div class="tips-box flex-s-c">
            <Checkbox style="margin-right:15px;" v-model="selectAll" @on-change="onCheckChange">
              <span style="font-size:16px;">全选</span>
            </Checkbox>
            <span class="m-r-5">{{tabList[curTabIndex] && tabList[curTabIndex].nickName}}</span>
            <span class="type-num">{{list.length}}</span>
            <span class="m-r-5">已选</span>
            <span class="type-num">{{curSelectedData.length}}</span>
            <a @click="onCheckChange(false)" v-if="curSelectedData.length>0">取消选择</a>
          </div>
          <div class="search-box">
            <rewrite-search v-model="searchVal" @search="search" placeholder="请输入关键词"></rewrite-search>
          </div>
        </div>
        <div class="flex-e-c" v-if="isShowSourceBox">
          <div class="source-tip">来源</div>
          <div class="source-box flex-s-c">
            <Select v-model="curSourceId" class="base-320">
                <Option v-for="item in sourceList" :key="item.supplierId" :value="item.supplierId">{{item.supplierName || ''}}</Option>
            </Select>
          </div>
        </div>
      </div>
      <materialList :list="list" @selectItem="selectItem" :type="type"></materialList>
    </div>
    <rewrite-page class="hold-layout-footer" :total="total" :current="page" :page-size="pageSize" :page-size-opts="pageSizeOpts" @on-change="e=>loadData(e)" @on-page-size-change="handlePageSizeChange" show-sizer show-elevator show-total transfer></rewrite-page>
  </div>
</template>

<script>
import materialList from "@/components/view-components/material-view/material-list.vue"
import ListMixin from "@/helper/mixin/list-mixin";
  export default {
    mixins:[ListMixin],
    components: {
      materialList,
    },
    props: {
      type: { //video,audio,article,
        type: String,
        default: "normal"
      },
      isShowTabs:{
        type: Boolean,
        default: false
      },
      isShowClassify:{
        type: Boolean,
        default: false
      },
      fromType:{ //distribute,content,material
        type: String,
        default: "" 
      },
      isMulti: {
        type: Boolean,
        default: false
      },
      classifyId:{
        type:Number,
        default:0
      },
      selectedData:{
        type:Array,
        default:function(){
          return []
        }
      },
      extraParams:{
        type:Object,
        default:function(){
          return {}
        }
      },
    },
    data() {
      return {
        curListId:0,
        selectAll:false,
        curTabIndex:0,
        curClassifyIndex:0,
        tabList: [{
          id:1,
          key:"video",
          name:"视频内容",
          nickName:"视频",
        },{
          id:2,
          key:"audio",
          name:"音频内容",
          nickName:"音频",
        },{
          id:3,
          key:"article",
          name:"文章内容",
          nickName:"文章",
        },
        // {
        //   id:4,
        //   key:"psychic",
        //   name:"心理咨询师",
        //   nickName:"心理咨询师",
        // }
        ],
        classifyList:[
          {
            id:0,
            name:"全部",
          },{
            id:1,
            name:"EAP学习素材",
          },{
            id:2,
            name:"企业员工心理培训资料",
          },{
            id:3,
            name:"家庭心理教育视频",
          },
        ], 
        curSelectedData:[],
        sourceList:[],
        curSourceId:0,
        searchVal:"",
      }
    },
    computed:{
      isShowTipsBox(){
        return !this.fromType || this.fromType=='distribute' || this.fromType=='material' || this.fromType=='customPages'
      },
      isShowSourceBox(){
        return this.fromType=='contentRepository';
      },
    },
    methods: {
      selectItem(index,item) {
        if(item.isDistribute == 1 || this.isShowSourceBox)return;
        let bool = !!!item._selected;
        this.$set(this.list[index],'_selected',bool);
        if(bool){
          this.curSelectedData.push(item);
          this.selectAll = this.list.every(item=>item._selected);
        }else{
          this.selectAll = false;
          this.curSelectedData.splice(this.curSelectedData.findIndex(cur_item=>cur_item.id == item.id),1);
        }
        console.log('selectItemselectItem',bool,this.curSelectedData,item)
        this.$set(this.list[index],'_selected',bool);
      },
      init(){
        let item = this.tabList[this.curTabIndex]||{};
        if(this.isShowSourceBox){
          this.curSourceId = 0;
          this.sourceList = [];
          return this.$MainApi.contentSourceList({
            data:{
              type:item.id || 0, 
            }
          }).then(res=>{
            if(res.code){
              this.sourceList = res.data||[];
              this.curSourceId = this.sourceList[0] && this.sourceList[0].supplierId || 0
            }
            return res
          })
        }
      },
      onLoadData(page,extraData){
        this.init();
        let curTabIndex = this.curTabIndex;
        return this.$MainApi.contentList({
          data:{
            ...extraData,
            structure_id:[0],
            source_id:this.curSourceId||0,
            type:this.tabList[curTabIndex] && this.tabList[curTabIndex].id || 0,
            ...(this.extraParams||{}),
          }
        }).then(res=>{
          if(res.code){
            let data = res.data||{};
            let list = data.list||[];
            let s_num = 0;
            let ids = this.curSelectedData.map(item=>item.id);
            let curItem = this.tabList[curTabIndex]||{};
            list = list.map(item=>{
              item = Object.assign({},{...item},{
                id:item[`${curItem.key}Id`]||0,
                title:item[`${curItem.key}Title`]||"",
                cover:item[`${curItem.key}CoverPic`]||"",
                summary:item[`${curItem.key}Description`]||"",
                durantion:item[`${curItem.key}TimeLength`]||0, 
                _selected:ids.includes(item[`${curItem.key}Id`]),
              })
              item._selected && s_num++;
              return item
            })
            this.data = {
              list,
              total:data.totalCount||0
            }
            this.selectAll = s_num == this.list.length;
          }
          return res;
        })
      },
      search(e){
        this.searchVal = e;
        this.curSelectedData = [];
        this.loadData();
      },
      getData(){
        return this.curSelectedData
      },
      onCheckChange(bool){
        this.curSelectedData = this.list.filter(item=>{
          item._selected = !!bool;
          return !!bool;
        })
        this.selectAll = !!bool;
      },
      onChangeTap(key,index){
        this[key] = index;
        this.curSelectedData = [];
        this.loadData();
      },
    },
    watch:{
      type:{
        handler(nV){
          this.curTabIndex = this.tabList.findIndex(item=>item.key == nV);
          setTimeout(() => {
            this.loadData();
          }, 500);
        },
        immediate:true
      },
      selectedData:{
        handler(nV){
          this.curSelectedData = JSON.parse(JSON.stringify(nV));
        },
        immediate:true
      }
    },
  }
</script>
<style lang="less" scoped>
.material-box{
  .ivu-select{
    color:#8e8e8e
  }
}
</style>
<style lang="less" scoped>
.material-box{
  position: relative;
  width: 100%;
  color: #7f7f7f;
  font-size: 16px; 
  height: 100%;
  &.left{
    flex-direction: row;
    .tabs{
      width:132px;
      border-right: 1px solid #EFEFEF;
      height: 100%;
      display: block;
    }
    .tab-item{
      text-align: center;
      padding-right: 0;
      height: 44px;
    }
  }
  &.onlyTabs{
    .content-box{
      height: calc(100% - 60px);
      padding-right: 0;
    }
  }
  .tabs{
    width: 100%;
    height: 60px;
    display: flex;
    padding-left: 20px;
    flex-shrink: 0;
    &.isBorder{
      border-bottom: 1px solid #DDDDDD;
    }
  }
  .tab-item{
    padding-right: 40px;
    height: 100%;
    &.active{
      color:#008ACB;
    }
  }
  .content-box{
    position: relative;
    padding-left: 20px;
    padding-right: 20px;
    height: 100%;
    &.classify{
      padding-top: 44px;
      &.tipsBox{
        padding-top:114px;
      };
    }
    &.tipsBox{
      padding-top:70px;
    }; 
    padding-bottom: 80px;
  }
  .filter-box{
    position:absolute;
    top: 0;
    right: 0;
    width: 100%;
  }
  .search-box{
    width:260px;
  }
  .classify-box{
    min-height: 50px;
  }
  .classify-item{
    min-width: 40px;
    min-height: 44px;
    padding: 0 20px;
    color: #333;
    border-radius: 4px;
    &.active{
      background: #F2FBFF;
      color: #008ACB;
    }
  }
  .tips-box,.source-box{
    min-height: 50px;
    margin: 10px 0;
  }
  .source-box{
    width: 165px;
  }
  .source-tip{
    margin-right:15px;
    font-size: 14px;
    color: #8e8e8e;
  }
  .type-num{
    color: #333;
    margin-right: 22px;
  } 
  .hold-layout-footer{ 
    position: absolute;
    left: 0;
    bottom: 0px;
    width: 100%; 
  }
  &.isSticky{
    .hold-layout-footer{
      position:sticky;
    }
    .content-box{
      padding-bottom: 20px;
    }
  }
}
</style>