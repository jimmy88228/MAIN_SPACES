<template>
    <div slot="base">
        <Form class="edit-activity" :label-width="180" ref="actDetailForm" :model="actDetail" :rules="ruleValidate">
            <FormItem label="活动标题" prop="activity_name"><!--:disabled="!isCanEdit('activity_name')"-->
                <custom-input size="large"  class="base-320" v-model="actDetail.activity_name" type="text" placeholder="" maxlength="30" :show-word-limit="true"></custom-input>
            </FormItem>
            <FormItem label="宣传图片">
                <img-view uploadType="activity" :img="actDetail.logo" @selectImg="selectActImg" @delImg="removeImage"></img-view>
                <span class="notice">建议尺寸200*200px</span>
            </FormItem>
            <FormItem label="活动时间" prop="dateTime">
                <date-time size="large"  style="width:320px;" type="datetimerange" v-model="actDetail.dateTime"></date-time>
            </FormItem>
            <FormItem label="活动说明">
                <custom-input size="large" :disabled="!isCanEdit('description')" class="base-320 base-textarea" v-model="actDetail.description" type="textarea" placeholder="" maxlength="150" :show-word-limit="true"></custom-input>
            </FormItem>
            <FormItem label="测评量表" prop="model_id">
                <data-select size="large" :disabled="!isCanEdit('model_id')" type="inventory" v-model="actDetail.model_id" class="base-320"></data-select>
            </FormItem>
            <FormItem label="活动状态">
                <i-switch v-model="actDetail.state" size="large" :true-value="1" :false-value="0">
                    <span slot="open">开启</span>
                    <span slot="close">关闭</span>
                </i-switch>
            </FormItem>
            <FormItem label="报告结果是否公开">
                <div class="radio-box flex-s-c">
                    <div v-for="item in is_report_open" :key="item.key" class="radio flex-c-c pointer" :class="[actDetail.is_report_open == item.key?'active':'',!isCanEdit('is_report_open') && actDetail.is_report_open != item.key?'bg_f3':'']" @click="radioClick(item.key,'is_report_open')">
                        <div class="radio-cir"></div>
                        <div class="radio-name">{{item.name}}</div>
                    </div>
                </div>
            </FormItem>
            <FormItem label="是否限制参与活动的平台">
                <i-switch v-model="actDetail.limit_platform" size="large" :true-value="1" :false-value="0">
                    <span slot="open">是</span>
                    <span slot="close">否</span>
                </i-switch>
            </FormItem>
            <FormItem label="选择限制参与活动的平台" prop="limit_platform_data"  v-if="actDetail.limit_platform == 1">
                <div  class="base-320">
                    <Select placement="top" v-model="actDetail.limit_platform_data" size="large" :multiple="true">
                        <Option :value="item.key" v-for="item in platformList" :key="item.key">{{item.name}}</Option>
                    </Select>
                </div>
            </FormItem>
        </Form>
    </div>
</template>

<script>
export default {
    mixins: [],
    props: {
      actDetail: {
        type: Object,
        default:()=>{
          return {}
        }
      }
    },
    data() {
        return {
            tabsData: [
                {
                    name: 'base',
                    label: '基础信息'
                },
                {
                    name: 'custom',
                    label: '自定义编辑'
                }
            ],
            is_report_open:[{name:'公开',key:1},{name:'不公开',key:0}],
            ruleValidate: {
                activity_name: [
                    {
                        required: true,
                        validator: this._checkString,
                        message: "活动名称不能为空",
                        trigger: "blur",
                    },
                ],
                dateTime: [
                    {
                        required: true,
                        type: "array",
                        validator: this._checkArray,
                        message: "活动时间不能为空",
                        trigger: "change",
                    },
                ],
                model_id: [
                    {
                        required: true,
                        validator: this._checkThanInt,
                        message: "活动测评量表不能为空",
                        trigger: "blur",
                    },
                ],
                limit_platform_data: [
                    {
                        required: true,
                        validator: this._checkArray,
                        message: "请选择限制平台",
                        trigger: "change",
                    },
                ]
            },
            platformList: [
                {
                    key: "WXAPP",
                    name: "小程序"
                },
                {
                    key: "H5",
                    name: "h5网页"
                }
            ]
        };
    },
    methods: {
        initData(){},
        save() {
          return new Promise((rs, rj)=>{
            this.$refs["actDetailForm"].validate((valid) => {
                if (valid) {
                    let req = Number(this.pageQuery.id)
                        ? (this.pageQuery.type == 'task' ? "assessmentTaskUpdate" : "appraisalActUpdate")
                        : (this.pageQuery.type == 'task' ? "assessmentTaskAdd" : "appraisalActAdd");
                    this.$MainApi[req]({
                        data: {
                            ...this.actDetail,
                            startTime: this.actDetail.dateTime[0],
                            endTime: this.actDetail.dateTime[1],
                        },
                    }).then((res) => {
                        if (res.code) {
                          let data = res.data || {};
                          if(data.id){
                            this.$router.replace({
                              name: this.$route.name,
                              query: {
                                    ...this.pageQuery,
                                    ...this.pageParams,
                                    id: data.id || 0,
                                    $isReplace: true
                                },
                            })
                            this.$emit("saveCallback", data)
                          }
                          return rs();
                        } else {
                          this.$Message.warning(res.message);
                          return rj();
                        }
                    }).catch(()=>{
                      return rj();
                    })
                } else {
                    this.$Message.info("请完善活动信息");
                    return rj();
                }
            });
          })
        },
        selectActImg(img){
            this.actDetail.logo = img;
        },
        removeImage(){
           this.actDetail.logo = ""; 
        },
        isCanEdit(type){
            let bool = true;
            if(Number(this.pageQuery.id)){
                bool = false
            }
            return bool
        },
        radioClick(cur,key){
            this.checkCanEdit('is_report_open');
            this.actDetail[key] = cur;
        },
        checkCanEdit(type=''){
            if(!this.isCanEdit(type)){
                throw new Error('不可编辑该内容');
            }
        }
    },
    mounted() {},
};
</script>

<style lang="less">
.edit-activity{
    .ivu-input{
        padding-right: 45px;
    }
    .radio{
        padding: 2px 10px;
        border-radius: 2px;
        background-color: #fff;
        transition: all 0.2s;
        border: 1px solid #DDDDDD;
        margin-right: 10px;
        .radio-cir{
            width: 16px;
            height: 16px;
            background-color: #FFFFFF;
            border: 1px solid #B2B2B2;
            position: relative;
            border-radius: 50%;
            margin-right: 10px;
        }
        &.active{
            background-color: #EFFAFF;
            color: #008ACB;
            .radio-cir{
                background-color: #008ACB;
                border: 1px solid #008ACB;
                position: relative;
                &::after{
                    content: "";
                    position: absolute;
                    width: 7px;
                    height: 7px;
                    border-radius: 50%;
                    left: 50%;
                    top: 50%;
                    transform: translate(-50%,-50%);
                    background-color: #fff;
                }
            }   
        }
    }
    .bg_f3{
        background: #f3f3f3;
        div{
            opacity: 0.5;
            color: #7f7f7f;
        }
    }
    .fixed_click{
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 2;
    }
}
</style>
// <style lang="less" scoped>
// .operate-area{
//     position: sticky;
//     left:0px;
//     bottom: 0px;
//     padding-left: 140px;
//     background-color:#fff;
// }
// </style>